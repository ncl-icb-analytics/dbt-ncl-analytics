version: 2

models:
  - name: pds_olids_reg_pass_secondary_use
    description: |
      Practices passing PDS registration count validation (Secondary Use).

      Use this for inner joins to filter datasets to practices with validated registration data.
      PDS models support opt-out filtering via sk_patient_id.

      Validation: <2% variance OR <5 persons difference (same threshold as EMIS)
      Methodology: PDS All Registration Types Comparison
      Includes: validation_methodology column describing the test

    config:
      meta:
        owner:
          name: Eddie Davison
    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1
          severity: warn

  - name: pds_olids_reg_fail_secondary_use
    description: |
      Practices failing PDS registration count validation (Secondary Use).

      These practices require investigation before use in analyses.
      PDS models support opt-out filtering via sk_patient_id.

      Validation: ≥2% variance AND ≥5 persons difference
      Methodology: PDS All Registration Types Comparison
      Includes: validation_methodology column and issue_category (2-5%, 5-20%, 20%+)

    config:
      meta:
        owner:
          name: Eddie Davison
    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1

  - name: pds_olids_reg_comparison_all_secondary_use
    description: |
      Complete PDS registration comparison for all practices with categorisation (Secondary Use).

      Categories: Major Difference (≥20%), Minor Difference (5-20%), Good Match (<5%), No Data
      PDS models support opt-out filtering via sk_patient_id.

      Methodology: PDS All Registration Types Comparison using merged NHS numbers

      Note: EMIS comparisons are NOT available in secondary_use layer as EMIS data
      cannot be joined to opt-out tables (no sk_patient_id).

    config:
      meta:
        owner:
          name: Eddie Davison
    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1
