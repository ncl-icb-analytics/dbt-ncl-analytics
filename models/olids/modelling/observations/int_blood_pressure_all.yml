version: 2
models:
  - name: int_blood_pressure_all
    description: 'Event-based blood pressure consolidation with paired systolic/diastolic values and clinical context identification.

      Key Features:

      • Event-based design: one row per person per date

      • Pairs systolic and diastolic values from multiple observations

      • Identifies clinical context (Home BP, ABPM)

      • Applies plausible value filtering (Systolic: 40-350 mmHg, Diastolic: 20-200 mmHg)

      • Uses six BP cluster types: BP_COD, SYSBP_COD, DIASBP_COD, HOMEAMBBP_COD, ABPM_COD, HOMEBP_COD

      Purpose: Provide consolidated blood pressure events for clinical analysis and BP control assessment.'
    tests:
      - cluster_ids_exist:
          cluster_ids: ABPM_COD, BP_COD, DIASBP_COD, HOMEAMBBP_COD, HOMEBP_COD, SYSBP_COD
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - person_id
            - clinical_effective_date
    columns:
      - name: person_id
        description: Person identifier
        tests:
          - not_null
          - relationships:
              to: ref('int_patient_person_unique')
              field: person_id
      - name: clinical_effective_date
        description: Date of blood pressure measurement
        tests:
          - not_null
      - name: systolic_value
        description: Systolic blood pressure value in mmHg
        tests:
          - dbt_utils.accepted_range:
              min_value: 40
              max_value: 350
              inclusive: true
              where: "systolic_value IS NOT NULL"
      - name: diastolic_value
        description: Diastolic blood pressure value in mmHg
        tests:
          - dbt_utils.accepted_range:
              min_value: 20
              max_value: 200
              inclusive: true
              where: "diastolic_value IS NOT NULL"
      - name: is_home_bp_event
        description: 'Boolean flag indicating if any observation on this date was recorded as home blood pressure (HOMEBP_COD, HOMEAMBBP_COD)'
      - name: is_abpm_bp_event
        description: 'Boolean flag indicating if any observation on this date was recorded as ambulatory blood pressure monitoring (ABPM_COD)'
      - name: result_unit_display
        description: 'Unit of measurement for blood pressure values (always mmHg)'
      - name: systolic_id
        description: 'Observation identifier for the systolic reading used in this consolidated event'
      - name: diastolic_id
        description: 'Observation identifier for the diastolic reading used in this consolidated event'
      - name: all_concept_codes
        description: 'Array of all clinical concept codes used in observations for this BP event date'
      - name: all_concept_displays
        description: 'Array of all clinical concept display names used in observations for this BP event date'
      - name: all_source_cluster_ids
        description: 'Array of all source cluster identifiers used in observations for this BP event date'
