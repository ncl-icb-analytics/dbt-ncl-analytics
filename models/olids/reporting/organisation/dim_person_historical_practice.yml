version: 2
models:
  - name: dim_person_historical_practice
    description: 'Complete practice registration history tracking patient mobility and practice transitions.

      Key Features:

      • One row per person per practice registration period

      • Registration timeline with start/end dates and duration calculations

      • Practice transition analysis with previous/next practice details

      • Registration sequence numbering for patient journey analysis

      • Gap analysis between registrations for continuity assessment

      • Current and latest registration flags for filtering

      Purpose: Supports patient mobility analysis, practice transition tracking, and continuity of care assessment.'

    columns:
      - name: person_id
        description: 'Unique person identifier'
        tests:
          - not_null

      - name: sk_patient_id
        description: 'Surrogate key for patient record'

      - name: practice_id
        description: 'OLIDS internal practice ID'
        tests:
          - not_null

      - name: practice_code
        description: 'Practice ODS code'
        tests:
          - not_null

      - name: practice_name
        description: 'Practice name'
        tests:
          - not_null

      - name: practice_type_code
        description: 'Practice type code from OLIDS'

      - name: practice_type_desc
        description: 'Practice type description'

      - name: practice_postcode
        description: 'Practice postcode'

      - name: practice_parent_org_id
        description: 'Parent organisation ID for practice'

      - name: practice_open_date
        description: 'Practice opening date'

      - name: practice_close_date
        description: 'Practice closure date (NULL if still open)'

      - name: practice_is_obsolete
        description: 'Flag indicating if practice record is obsolete'
        tests:
          - not_null

      - name: registration_start_date
        description: 'Start date of this registration period'
        tests:
          - not_null

      - name: registration_end_date
        description: 'End date of this registration period (NULL if still active)'

      - name: effective_end_date
        description: 'Effective end date for registration (for SCD calculations)'

      - name: registration_duration_days
        description: 'Duration of this registration period in days'

      - name: registration_status
        description: 'Status of this registration (e.g., Active, Ended)'

      - name: registration_type
        description: 'Type classification (Open Registration, Closed Registration)'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['Open Registration', 'Closed Registration']

      - name: is_current_registration
        description: 'Flag indicating if this is the current active registration'
        tests:
          - not_null

      - name: is_latest_registration
        description: 'Flag indicating if this is the most recent registration (current or last)'
        tests:
          - not_null

      - name: registration_sequence
        description: 'Sequential number of this registration for the person'
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1

      - name: total_registrations_count
        description: 'Total number of registrations this person has had'
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1

      - name: gap_since_previous_registration_days
        description: 'Number of days between this registration and the previous one'

      - name: has_changed_practice
        description: 'Flag indicating if person has ever changed practice'
        tests:
          - not_null

      - name: age_at_registration_start
        description: 'Persons approximate age when this registration started'

      - name: practitioner_id
        description: 'Practitioner ID associated with this registration'

      - name: previous_practice_id
        description: 'Previous practice ID in sequence'

      - name: previous_practice_name
        description: 'Previous practice name in sequence'

      - name: previous_registration_end_date
        description: 'End date of previous registration'

      - name: next_practice_id
        description: 'Next practice ID in sequence'

      - name: next_practice_name
        description: 'Next practice name in sequence'

      - name: next_registration_start_date
        description: 'Start date of next registration'

      - name: is_first_registration
        description: 'Flag indicating if this is the first registration for this person'
        tests:
          - not_null

      - name: is_last_registration
        description: 'Flag indicating if this is the last registration for this person'
        tests:
          - not_null

    # Note: No uniqueness test on (person_id, registration_start_date, practice_id) 
    # because multiple patient_ids can map to the same person_id by design,
    # allowing proper tracking of patient registration history across practices


