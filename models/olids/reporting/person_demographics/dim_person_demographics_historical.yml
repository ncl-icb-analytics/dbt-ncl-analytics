version: 2

models:
  - name: dim_person_demographics_historical
    description: 'Historical Person Demographics - Person-Month Grain

      Provides person demographics at monthly granularity for complete temporal analysis.
      One row per person per month with demographics valid for that specific month.

      Key Features:

      • Person-month grain for temporal demographic analysis

      • Age calculated accurately for each analysis month

      • Practice registration status as of each month

      • Ethnicity and address data as recorded by each month

      • 5-year rolling history window for performance

      Data Quality Filtering:

      • Excludes persons without birth dates (required for age)

      • Excludes persons without any registration history

      • Maintains temporal accuracy for all demographic attributes

      For analysis queries using specific months.'

    columns:
      - name: analysis_month
        description: 'Month end date for this record'
        tests:
          - not_null

      - name: person_id
        description: 'Unique person identifier'
        tests:
          - not_null

      - name: sk_patient_id
        description: 'Surrogate key for patient record'

      - name: is_active
        description: 'Active registration status for this month'
        tests:
          - not_null

      - name: is_deceased
        description: 'Death status flag'
        tests:
          - not_null

      - name: is_dummy_patient
        description: 'Dummy patient record flag'
        tests:
          - not_null

      - name: inactive_reason
        description: 'Reason for inactive status (Deceased, Registration ended, or NULL)'

      - name: birth_year
        description: 'Birth year'

      - name: birth_month
        description: 'Birth month'

      - name: birth_date_approx
        description: 'Approximate birth date'

      - name: birth_date_approx_end_of_month
        description: 'Birth date approximated to end of birth month'

      - name: death_year
        description: 'Death year if deceased'

      - name: death_month
        description: 'Death month if deceased'

      - name: death_date_approx
        description: 'Approximate death date if deceased'

      - name: age
        description: 'Age calculated as of analysis_month'

      - name: age_at_least
        description: 'Conservative age calculation as of analysis_month'

      - name: age_band_5y
        description: '5-year age bands as of analysis_month (0-4, 5-9, 10-14, ..., 80-84, 85+)'

      - name: age_band_10y
        description: '10-year age bands as of analysis_month (0-9, 10-19, 20-29, ..., 70-79, 80+)'

      - name: age_band_nhs
        description: 'NHS Digital age bands as of analysis_month (0-4, 5-14, 15-24, 25-34, 35-44, 45-54, 55-64, 65-74, 75-84, 85+)'

      - name: age_band_ons
        description: 'ONS age bands as of analysis_month (0-4, 5-9, 10-14, 15-19, 20-24, 25-29, ..., 80-84, 85+)'

      - name: age_life_stage
        description: 'Life stage categories as of analysis_month (Infant, Toddler, Child, Adolescent, Young Adult, Adult, Senior, Elderly, Very Elderly)'

      - name: is_primary_school_age
        description: 'Flag indicating primary school age as of analysis_month (ages 4-10)'
        tests:
          - not_null

      - name: is_secondary_school_age
        description: 'Flag indicating secondary school age as of analysis_month (ages 11-17)'
        tests:
          - not_null

      - name: sex
        description: 'Sex'

      - name: ethnicity_category
        description: 'Ethnicity category as recorded by this month'

      - name: ethnicity_subcategory
        description: 'Ethnicity subcategory as recorded by this month'

      - name: ethnicity_granular
        description: 'Detailed ethnicity as recorded by this month'

      - name: ethnicity_category_sort
        description: 'Sort order for ethnicity category'

      - name: ethnicity_display_sort_key
        description: 'Display sort key for ethnicity'

      - name: main_language
        description: 'Main language'

      - name: language_type
        description: 'Language type classification'

      - name: interpreter_type
        description: 'Type of interpreter needed'

      - name: interpreter_needed
        description: 'Interpreter needed flag'

      - name: practice_code
        description: 'Practice code active during this month'

      - name: practice_name
        description: 'Practice name active during this month'

      - name: registration_start_date
        description: 'Start date of practice registration for this month'

      - name: registration_end_date
        description: 'End date of practice registration (NULL if active during this month)'

      - name: pcn_code
        description: 'Primary Care Network code'

      - name: pcn_name
        description: 'Primary Care Network name'

      - name: pcn_name_with_borough
        description: 'PCN name with borough prefix'

      - name: borough_registered
        description: 'Practice borough'

      - name: practice_postcode
        description: 'Practice postcode'

      - name: practice_lsoa
        description: 'Practice LSOA'

      - name: practice_msoa
        description: 'Practice MSOA'

      - name: practice_latitude
        description: 'Practice latitude coordinate'

      - name: practice_longitude
        description: 'Practice longitude coordinate'

      - name: neighbourhood_registered
        description: 'Practice neighbourhood classification'

      - name: post_code_hash
        description: 'Patient address postcode hash'

      - name: uprn_hash
        description: 'Patient address UPRN hash'

      - name: household_id
        description: 'Household identifier'

      - name: lsoa_code_21
        description: 'LSOA code 2021'

      - name: lsoa_name_21
        description: 'LSOA name 2021'

      - name: ward_code
        description: 'Ward code'

      - name: ward_name
        description: 'Ward name'

      - name: imd_decile_19
        description: 'IMD decile 2019'

      - name: imd_quintile_19
        description: 'IMD quintile 2019'

      - name: neighbourhood_resident
        description: 'Patient neighbourhood classification'

    tests:
      - dbt_utils.unique_combination_of_columns:
          name: dim_person_demographics_historical_unique_person_month
          arguments:
            combination_of_columns:
              - person_id
              - analysis_month