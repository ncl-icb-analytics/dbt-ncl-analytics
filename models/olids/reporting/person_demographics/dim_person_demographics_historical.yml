version: 2

models:
  - name: dim_person_demographics_historical
    description: 'Historical Person Demographics - Person-Month Grain

      Provides person demographics at monthly granularity for complete temporal analysis.
      One row per person per month with demographics valid for that specific month.

      Key Features:

      • Person-month grain for temporal demographic analysis

      • Age calculated accurately for each analysis month

      • Practice registration status as of each month

      • Ethnicity as recorded by each month

      • 5-year rolling history window for performance

      Data Quality Filtering:

      • Excludes persons without birth dates (required for age)

      • Excludes persons without any registration history

      • Maintains temporal accuracy for all demographic attributes

      Known Limitations:

      • Address/geographic fields use current address for all historical months (address history dates not available)

      For analysis queries using specific months.'

    columns:
      - name: analysis_month
        description: 'Month end date for this record'
        tests:
          - not_null

      - name: person_id
        description: 'Unique person identifier'
        tests:
          - not_null

      - name: sk_patient_id
        description: 'Surrogate key for patient record'

      - name: is_active
        description: 'Active registration status for this month'
        tests:
          - not_null

      - name: is_deceased
        description: 'Death status flag'
        tests:
          - not_null

      - name: is_dummy_patient
        description: 'Dummy patient record flag'
        tests:
          - not_null

      - name: inactive_reason
        description: 'Reason for inactive status (Deceased, Registration ended, or NULL)'

      - name: birth_year
        description: 'Birth year'

      - name: birth_month
        description: 'Birth month'

      - name: birth_date_approx
        description: 'Approximate birth date'

      - name: birth_date_approx_end_of_month
        description: 'Birth date approximated to end of birth month'

      - name: death_year
        description: 'Death year if deceased'

      - name: death_month
        description: 'Death month if deceased'

      - name: death_date_approx
        description: 'Approximate death date if deceased'

      - name: age
        description: 'Age calculated as of analysis_month'

      - name: age_at_least
        description: 'Conservative age calculation as of analysis_month'

      - name: age_band_5y
        description: '5-year age bands as of analysis_month (0-4, 5-9, 10-14, ..., 80-84, 85+)'

      - name: age_band_10y
        description: '10-year age bands as of analysis_month (0-9, 10-19, 20-29, ..., 70-79, 80+)'

      - name: age_band_nhs
        description: 'NHS Digital age bands as of analysis_month (0-4, 5-14, 15-24, 25-34, 35-44, 45-54, 55-64, 65-74, 75-84, 85+)'

      - name: age_band_ons
        description: 'ONS age bands as of analysis_month (0-4, 5-9, 10-14, 15-19, 20-24, 25-29, ..., 80-84, 85+)'

      - name: age_life_stage
        description: 'Life stage categories as of analysis_month (Infant, Toddler, Child, Adolescent, Young Adult, Adult, Senior, Elderly, Very Elderly)'

      - name: is_primary_school_age
        description: 'Flag indicating primary school age as of analysis_month (ages 4-10)'
        tests:
          - not_null

      - name: is_secondary_school_age
        description: 'Flag indicating secondary school age as of analysis_month (ages 11-17)'
        tests:
          - not_null

      - name: sex
        description: 'Sex'

      - name: ethnicity_category
        description: 'Ethnicity category as recorded by this month'

      - name: ethnicity_subcategory
        description: 'Ethnicity subcategory as recorded by this month'

      - name: ethnicity_granular
        description: 'Detailed ethnicity as recorded by this month'

      - name: ethnicity_category_sort
        description: 'Sort order for ethnicity category'

      - name: ethnicity_display_sort_key
        description: 'Display sort key for ethnicity'

      - name: main_language
        description: 'Main language'

      - name: language_type
        description: 'Language type classification'

      - name: interpreter_type
        description: 'Type of interpreter needed'

      - name: interpreter_needed
        description: 'Interpreter needed flag'

      - name: practice_code
        description: 'Practice code active during this month'

      - name: practice_name
        description: 'Practice name active during this month'

      - name: registration_start_date
        description: 'Start date of practice registration for this month'

      - name: registration_end_date
        description: 'End date of practice registration (NULL if active during this month)'

      - name: pcn_code
        description: 'Primary Care Network code'

      - name: pcn_name
        description: 'Primary Care Network name'

      - name: pcn_name_with_borough
        description: 'PCN name with borough prefix'

      - name: icb_code
        description: 'Integrated Care Board (ICB) code where patient was registered during this month (practice-based)'

      - name: icb_name
        description: 'Integrated Care Board (ICB) name where patient was registered during this month (practice-based)'

      - name: borough_registered
        description: 'Practice borough where patient was registered during this month'

      - name: practice_postcode
        description: 'Practice postcode'

      - name: practice_lsoa
        description: 'Practice LSOA'

      - name: practice_msoa
        description: 'Practice MSOA'

      - name: practice_latitude
        description: 'Practice latitude coordinate'

      - name: practice_longitude
        description: 'Practice longitude coordinate'

      - name: neighbourhood_registered
        description: 'Practice neighbourhood classification'

      - name: postcode_hash
        description: 'Patient residential address postcode hash for privacy protection (current address used for all months)'

      - name: uprn_hash
        description: 'Patient address Unique Property Reference Number hash (placeholder for future use)'

      - name: household_id
        description: 'Household identifier linking persons at same address (placeholder for future use)'

      - name: icb_code_resident
        description: 'Integrated Care Board (ICB) code where patient resided during this month (from postcode lookup)'

      - name: icb_resident
        description: 'Integrated Care Board (ICB) name where patient resided during this month (distinct from registration ICB)'

      - name: local_authority_code
        description: 'Local Authority District 2025 code (LAD25CD) where patient resided during this month'

      - name: local_authority_name
        description: 'Local Authority District 2025 name (LAD25NM) where patient resided during this month'

      - name: borough_resident
        description: 'London borough where patient resided during this month (NULL for non-London residents)'

      - name: is_london_resident
        description: 'Flag indicating if patient resided in Greater London area during this month'

      - name: london_classification
        description: 'London area classification during this month (NCL, Other London, Outside London)'

      - name: lsoa_code_21
        description: 'Lower Layer Super Output Area 2021 census code where patient resided during this month'

      - name: lsoa_name_21
        description: 'Lower Layer Super Output Area 2021 census name where patient resided during this month'

      - name: ward_code
        description: 'Electoral Ward 2025 code (WD25CD) where patient resided during this month'

      - name: ward_name
        description: 'Electoral Ward 2025 name (WD25NM) where patient resided during this month'

      - name: imd_decile_19
        description: 'Index of Multiple Deprivation 2019 decile where patient resided during this month (1=most deprived, 10=least deprived)'

      - name: imd_quintile_19
        description: 'Index of Multiple Deprivation 2019 quintile text labels where patient resided during this month (Most Deprived to Least Deprived)'

      - name: imd_quintile_numeric_19
        description: 'Index of Multiple Deprivation 2019 numeric quintile where patient resided during this month (1=most deprived, 5=least deprived)'

      - name: neighbourhood_resident
        description: 'NCL neighbourhood classification where patient resided during this month (based on 2021 LSOA)'

      - name: is_current_period
        description: 'Flag indicating if this analysis_month represents the current/latest month'

      - name: effective_start_date
        description: 'First day of the analysis month (SCD2 compatibility field)'

      - name: effective_end_date
        description: 'Last day of the analysis month (NULL for current month, SCD2 compatibility field)'

      - name: period_sequence
        description: 'Sequential number of analysis months for each person (1, 2, 3, ...)'

      - name: age_changes_in_period
        description: 'Flag indicating if age incremented during this analysis month (birth month anniversary)'

    tests:
      - dbt_utils.unique_combination_of_columns:
          name: dim_person_demographics_historical_unique_person_month
          arguments:
            combination_of_columns:
              - person_id
              - analysis_month