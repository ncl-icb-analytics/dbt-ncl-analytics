version: 2

models:
  - name: dim_person_age_historical
    description: 'Historical Person Age Dimension Table (Type 2 SCD)

      Calculates age and age bands using modern Type 2 slowly changing dimensions approach.
      Only creates rows when age bands actually change.

      Key Features:

      • Type 2 SCD with effective_start_date and effective_end_date (NULL = current period)

      • 5-year rolling history window for performance optimisation

      • Modern SCD2 implementation without sentinel dates (no 9999-12-31 values)

      • Age milestones trigger new periods (every 5 years for age band changes)

      • Efficient storage - periods created only when age bands change, not monthly

      Implementation Notes:

      • Uses NULL effective_end_date for current periods (not sentinel dates)

      • Limited to last 5 years of data to balance completeness with performance

      • Change points triggered by: age milestones at 5-year intervals (0, 5, 10, 15, etc.)

      For analysis queries, join using:
      WHERE analysis_date >= effective_start_date AND (effective_end_date IS NULL OR analysis_date < effective_end_date)'

    columns:
      - name: person_id
        description: 'Unique person identifier'
        tests:
          - not_null

      - name: effective_start_date
        description: 'SCD2: Period start date for temporal tracking'
        tests:
          - not_null

      - name: effective_end_date
        description: 'SCD2: Period end date for temporal tracking (NULL = current period)'

      - name: period_sequence
        description: 'SCD2: Sequential number for each temporal period per person'
        tests:
          - not_null

      - name: age
        description: 'SCD2: Age calculated as of effective_start_date (temporal)'

      - name: age_band_5y
        description: 'SCD2: 5-year age band as of effective_start_date (temporal)'

      - name: age_band_10y
        description: 'SCD2: 10-year age band as of effective_start_date (temporal)'

      - name: age_band_nhs
        description: 'SCD2: NHS age band as of effective_start_date (temporal)'

      - name: age_band_ons
        description: 'SCD2: ONS age band as of effective_start_date (temporal)'

      - name: age_life_stage
        description: 'SCD2: Life stage as of effective_start_date (temporal)'

      - name: is_current_period
        description: 'SCD2: Flag indicating if this is the current active period'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [true, false]

    tests:
      # SCD2 integrity tests
      - dbt_utils.unique_combination_of_columns:
          name: dim_person_age_historical_unique_person_period
          arguments:
            combination_of_columns:
              - person_id
              - effective_start_date

      # Basic data quality tests
      - dbt_utils.expression_is_true:
          name: dim_person_age_historical_valid_date_ranges
          arguments:
            expression: "effective_end_date IS NULL OR effective_start_date <= effective_end_date"

      - dbt_utils.expression_is_true:
          name: dim_person_age_historical_current_period_consistency
          arguments:
            expression: "(effective_end_date IS NULL AND is_current_period = true) OR (effective_end_date IS NOT NULL)"