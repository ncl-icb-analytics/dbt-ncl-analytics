version: 2
models:
  - name: int_bmi_latest
    description: 'Most recent valid BMI measurement per person with ethnicity-adjusted categorisation.

      One row per person with their latest BMI including ethnicity-adjusted clinical categorisation per NICE NG246. Uses lower BMI thresholds for cardiometabolic risk populations.

      Key Features:

      • Latest valid BMI per person with ethnicity-adjusted thresholds

      • Includes both standard and ethnicity-adjusted categorisations

      • Provides ethnicity context for clinical decision-making

      Purpose: Supports clinical assessment and population health monitoring with appropriate ethnic considerations.'
    
    config:
      meta:
        indicator:
          id: "BRF_BMI_CATEGORIES"
          type: "RISK_FACTOR"
          category: "BEHAVIOURAL_RISK_FACTOR"
          clinical_domain: "Lifestyle"
          name_short: "Adult BMI Categories"
          description_short: "Adult BMI categories with ethnicity-adjusted thresholds for cardiometabolic risk"
          description_long: >
            Adult BMI categorisation (age 18+) using ethnicity-adjusted thresholds per NICE NG246.
            Standard populations use conventional BMI categories (overweight ≥25, obese ≥30).
            Populations with increased cardiometabolic risk (South Asian, Chinese, other Asian, 
            Middle Eastern, Black African, African-Caribbean) use lower thresholds 
            (overweight ≥23, obese ≥27.5) to reflect increased risk at lower BMI levels.
            Age restriction: Adult BMI categories are only clinically appropriate for ages 18+.
          is_qof: false
          source_column: "bmi_category"
          sort_order: "BRF_1_BMI_CATEGORIES"
          usage_contexts:
            - "POPULATION_HEALTH_NEEDS_DASHBOARD"
          code_clusters:
            - cluster_id: "BMIVAL_COD"
              category: "INCLUSION"
            - cluster_id: "HEIGHT"
              category: "CALCULATION"
            - cluster_id: "WEIGHT"
              category: "CALCULATION"
            # Ethnicity clusters for cardiometabolic risk adjustment
            - cluster_id: "ETH2016AI_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016AP_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016AB_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016AC_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016AO_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016MWA_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016OA_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016BA_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016MWBA_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016BC_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016MWBC_COD"
              category: "REFINEMENT"
            - cluster_id: "ETH2016BO_COD"
              category: "REFINEMENT"
          thresholds:
            # Universal thresholds
            - population_group: "ALL"
              threshold_type: "UNDERWEIGHT"
              threshold_value: "18.5"
              threshold_operator: "BELOW"
              threshold_unit: "kg/m²"
              description: "Underweight threshold for all populations"
              sort_order: 1
            # Standard population thresholds
            - population_group: "STANDARD"
              threshold_type: "NORMAL"
              threshold_value: "18.5-24.9"
              threshold_operator: "BETWEEN"
              threshold_unit: "kg/m²"
              description: "Normal BMI range for standard populations"
              sort_order: 2
            - population_group: "STANDARD"
              threshold_type: "OVERWEIGHT"
              threshold_value: "25-29.9"
              threshold_operator: "BETWEEN"
              threshold_unit: "kg/m²"
              description: "Overweight range for standard populations"
              sort_order: 3
            - population_group: "STANDARD"
              threshold_type: "OBESE_CLASS_I"
              threshold_value: "30-34.9"
              threshold_operator: "BETWEEN"
              threshold_unit: "kg/m²"
              description: "Obese Class I range for standard populations"
              sort_order: 4
            - population_group: "STANDARD"
              threshold_type: "OBESE_CLASS_II"
              threshold_value: "35-39.9"
              threshold_operator: "BETWEEN"
              threshold_unit: "kg/m²"
              description: "Obese Class II range for standard populations"
              sort_order: 5
            - population_group: "STANDARD"
              threshold_type: "OBESE_CLASS_III"
              threshold_value: "40"
              threshold_operator: "AT_OR_ABOVE"
              threshold_unit: "kg/m²"
              description: "Obese Class III threshold for standard populations"
              sort_order: 6
            # Cardiometabolic risk populations
            - population_group: "CARDIOMETABOLIC_RISK"
              threshold_type: "NORMAL"
              threshold_value: "18.5-22.9"
              threshold_operator: "BETWEEN"
              threshold_unit: "kg/m²"
              description: "Normal BMI range for populations with increased cardiometabolic risk"
              sort_order: 7
            - population_group: "CARDIOMETABOLIC_RISK"
              threshold_type: "OVERWEIGHT"
              threshold_value: "23-27.4"
              threshold_operator: "BETWEEN"
              threshold_unit: "kg/m²"
              description: "Overweight range for populations with increased cardiometabolic risk"
              sort_order: 8
            - population_group: "CARDIOMETABOLIC_RISK"
              threshold_type: "OBESE_CLASS_I"
              threshold_value: "27.5-32.4"
              threshold_operator: "BETWEEN"
              threshold_unit: "kg/m²"
              description: "Obese Class I range for populations with increased cardiometabolic risk"
              sort_order: 9
            - population_group: "CARDIOMETABOLIC_RISK"
              threshold_type: "OBESE_CLASS_II"
              threshold_value: "32.5-37.4"
              threshold_operator: "BETWEEN"
              threshold_unit: "kg/m²"
              description: "Obese Class II range for populations with increased cardiometabolic risk"
              sort_order: 10
            - population_group: "CARDIOMETABOLIC_RISK"
              threshold_type: "OBESE_CLASS_III"
              threshold_value: "37.5"
              threshold_operator: "AT_OR_ABOVE"
              threshold_unit: "kg/m²"
              description: "Obese Class III threshold for populations with increased cardiometabolic risk"
              sort_order: 11
    
    columns:
      - name: person_id
        description: Unique identifier for the person
        tests:
          - not_null
          - unique
      - name: age
        description: 'Age in years at time of analysis (adults 18+ only)'
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 18
              max_value: 150
              inclusive: true
      - name: id
        description: Latest BMI observation identifier
        tests:
          - not_null
      - name: clinical_effective_date
        description: Date of latest BMI observation
        tests:
          - not_null
      - name: bmi_value
        description: BMI value in kg/m²
        tests:
          - not_null
      - name: bmi_source
        description: 'Source of BMI value (recorded or calculated)'
        tests:
          - not_null
          - accepted_values:
              values: ['recorded', 'calculated']
      - name: requires_lower_bmi_thresholds
        description: 'Flag indicating if person requires lower BMI thresholds per NICE NG246'
      - name: cardiometabolic_risk_ethnicity_group
        description: 'Ethnicity group classification for cardiometabolic risk assessment'
      - name: is_valid_bmi
        description: 'Flag indicating BMI value is within valid range (10-150)'
        tests:
          - not_null
          - accepted_values:
              values: [true]
      - name: bmi_category
        description: 'BMI categorisation using ethnicity-adjusted thresholds per NICE NG246'
        tests:
          - not_null
          - accepted_values:
              values: ['Underweight', 'Normal', 'Overweight', 'Obese Class I', 'Obese Class II', 'Obese Class III']
      - name: bmi_risk_sort_key
        description: 'BMI risk sort key using ethnicity-adjusted thresholds (higher = higher risk)'
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 6
              inclusive: true
