version: 2
models:
  - name: int_ckd_lab_classification
    description: 'Laboratory-based CKD staging and criteria assessment using latest eGFR and ACR results.

      Key Features:

      • CKD staging using G-stage (G1-G5) and A-stage (A1-A3) classification

      • Persistent abnormal result confirmation (two abnormal results 90-730 days apart)

      • CKD criteria assessment: eGFR <60 or (eGFR ≥60 and ACR ≥3)

      • Combines latest laboratory results with historical confirmation

      • Person-level aggregation for case finding and audit

      Purpose: Identify people whose laboratory results meet CKD criteria regardless of clinical diagnosis.'

    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1

    columns:
      - name: person_id
        description: 'Unique identifier for the person'
        tests:
          - unique
          - not_null
      - name: latest_egfr_value
        description: 'Most recent estimated glomerular filtration rate value (mL/min/1.73m²)'
      - name: latest_egfr_date
        description: 'Date of the most recent eGFR measurement'
      - name: latest_egfr_stage
        description: 'CKD G-stage classification based on latest eGFR (G1-G5)'
      - name: latest_acr_value
        description: 'Most recent albumin-to-creatinine ratio value (mg/mmol)'
      - name: latest_acr_date
        description: 'Date of the most recent ACR measurement'
      - name: latest_acr_stage
        description: 'CKD A-stage classification based on latest ACR (A1-A3)'
      - name: has_confirmed_low_egfr
        description: 'Boolean flag indicating persistent low eGFR (<60) confirmed by two measurements 90-730 days apart'
      - name: has_confirmed_high_acr
        description: 'Boolean flag indicating persistent high ACR (≥3) confirmed by two measurements 90-730 days apart'
      - name: latest_ckd_stage_inferred
        description: 'Combined CKD stage inference using latest G-stage and A-stage (e.g., "G3a A2")'
      - name: latest_labs_meet_ckd_criteria
        description: 'Boolean flag indicating if latest laboratory results meet CKD criteria (eGFR <60 or eGFR ≥60 and ACR ≥3)'
      - name: has_confirmed_ckd_by_labs
        description: 'Boolean flag indicating confirmed CKD based on persistent abnormal laboratory results'
