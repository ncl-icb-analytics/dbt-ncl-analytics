version: 2
models:
  - name: int_eosinophil_count
    description: >
      Blood eosinophil count observations with unit standardisation and data quality flags.
      One row per observation using the EOS_COUNT cluster. Applies a value-first standardisation
      workflow via the standardise_count_observation macro to infer correct units and values,
      then categorises by clinical severity. Standard unit: 10*9/L.
    config:
      meta:
        owner:
          name: ThomasShallcross
    columns:
      - name: id
        description: Unique observation identifier
        data_tests:
          - not_null
          - unique
      - name: person_id
        description: Person identifier
        data_tests:
          - not_null
      - name: clinical_effective_date
        description: Date of observation
        data_tests:
          - not_null
      - name: concept_code
        description: SNOMED code for the observation
      - name: code_description
        description: SNOMED code description
      - name: source_cluster_id
        description: Cluster ID from get_observations
      - name: original_result_value
        description: Raw value from source data before any conversion
      - name: original_result_unit_display
        description: Raw unit display text from source data
      - name: original_result_unit_code
        description: Raw unit code from source data
      - name: expected_measurement_type
        description: Always COUNT for this model
      - name: inferred_unit
        description: Standardised unit after inference (10*9/L or NULL if NONE confidence)
      - name: inferred_value
        description: Standardised numeric value after any conversion
        data_tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
              inclusive: true
              where: "is_valid_eosinophil = TRUE"
      - name: value_was_converted
        description: TRUE if the numeric value was mathematically converted
      - name: unit_was_changed
        description: TRUE if inferred_unit differs from original_result_unit_code, NULL if inference failed
      - name: conversion_reason
        description: Human-readable explanation of standardisation action taken
      - name: confidence
        description: Confidence level in the inferred value
        data_tests:
          - accepted_values:
              values: ['VERY_HIGH', 'HIGH', 'MEDIUM', 'LOW', 'NONE']
      - name: is_negative
        description: TRUE if inferred value is negative
      - name: is_extreme_outlier
        description: TRUE if inferred value exceeds 100 x10*9/L
      - name: is_valid_eosinophil
        description: TRUE if inferred value is plausible and usable for analysis
      - name: eosinophil_category
        description: Clinical severity category based on inferred value
        data_tests:
          - accepted_values:
              values:
                - 'Invalid'
                - 'Eosinopenia'
                - 'Normal'
                - 'Mild Eosinophilia'
                - 'Moderate Eosinophilia'
                - 'Severe Eosinophilia'
