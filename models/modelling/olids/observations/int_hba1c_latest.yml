version: 2
models:
  - name: int_hba1c_latest
    description: 'Intermediate: Latest HbA1c Observations - Most recent valid HbA1c
      measurement per person.

      Clinical Logic:

      • Provides current glycaemic control status for diabetes management

      • Supports diabetes care decision-making and QOF reporting

      • Enables current diabetes control assessment and treatment planning


      Data Granularity:

      • One row per person with their most recent valid HbA1c

      • Includes only patients with valid HbA1c measurements

      • Supports both IFCC and DCCT measurement formats


      Key Features:

      • Latest valid HbA1c identification with measurement type preservation

      • Clinical diabetes control categorisation for care pathway management

      • QOF target achievement flags for quality indicator reporting

      • Diabetes diagnostic indicators for clinical decision support'

    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1

    columns:
      - name: person_id
        tests:
          - unique
          - not_null

    config:
      meta:
        indicator:
          id: "HBA1C_LATEST"
          type: "PATHOLOGY"
          category: "LABORATORY_RESULT"
          clinical_domain: "Cardiometabolic"
          name_short: "Latest HbA1c"
          description_short: "Most recent HbA1c measurement for glycaemic control
            assessment"
          description_long: >
            Latest valid HbA1c measurement per person supporting diabetes management
            and care pathway
            decisions. Provides current glycaemic control status with both IFCC and
            DCCT measurement
            format support. Includes clinical categorisation for diabetes control
            assessment (≤48 mmol/mol
            excellent, ≤58 mmol/mol adequate, >75 mmol/mol poor), QOF target achievement
            flags (≤58 mmol/mol),
            and diagnostic indicators (≥48 mmol/mol diabetes, ≥42 mmol/mol prediabetes).
            Key biomarker
            for diabetes care quality monitoring and treatment optimisation.
          is_qof: false
          source_column: "hba1c_value"
          usage_contexts:
            - "LABORATORY_MONITORING"
          code_clusters:
            - cluster_id: "HBA1C_COD"
              category: "INCLUSION"
          thresholds:
            # QOF Targets
            - population_group: "DIABETES"
              threshold_type: "QOF_TARGET"
              threshold_value: "58"
              threshold_operator: "AT_OR_BELOW"
              threshold_unit: "mmol/mol"
              description: "QOF glycaemic control target for diabetes"
              sort_order: 1
            # Clinical Control Categories
            - population_group: "ALL"
              threshold_type: "GOOD_CONTROL"
              threshold_value: "48"
              threshold_operator: "AT_OR_BELOW"
              threshold_unit: "mmol/mol"
              description: "Excellent glycaemic control"
              sort_order: 2
            - population_group: "ALL"
              threshold_type: "ADEQUATE_CONTROL"
              threshold_value: "58"
              threshold_operator: "AT_OR_BELOW"
              threshold_unit: "mmol/mol"
              description: "Adequate glycaemic control"
              sort_order: 3
            - population_group: "ALL"
              threshold_type: "POOR_CONTROL"
              threshold_value: "75"
              threshold_operator: "ABOVE"
              threshold_unit: "mmol/mol"
              description: "Poor glycaemic control requiring intervention"
              sort_order: 4
            # Diagnostic Thresholds
            - population_group: "ALL"
              threshold_type: "DIABETES_DIAGNOSIS"
              threshold_value: "48"
              threshold_operator: "AT_OR_ABOVE"
              threshold_unit: "mmol/mol"
              description: "HbA1c threshold for diabetes diagnosis"
              sort_order: 5
            - population_group: "ALL"
              threshold_type: "PREDIABETES_LOWER"
              threshold_value: "42"
              threshold_operator: "AT_OR_ABOVE"
              threshold_unit: "mmol/mol"
              description: "Lower threshold for prediabetes (NDH) diagnosis"
              sort_order: 6
        owner:
          name: EddieDavison92
