version: 2

models:
  - name: int_polypharmacy_current
    description: |
      Current polypharmacy medication counts and flags.

      Grain: One row per person (only persons with current polypharmacy medications)

      Inclusion criteria:
      - Persons with at least 1 current polypharmacy-scope medication
      - Medications counted from int_polypharmacy_medications_current (source of truth)

      Polypharmacy scope uses exclusion-based filtering:
      - Excludes most infections (except HIV and hepatitis antivirals)
      - Excludes vitamins, minerals, nutrition products
      - Excludes contraceptives, thyroid drugs, topicals
      - Excludes devices, dressings, appliances
      - See int_polypharmacy_medications_list for complete scope definition

      Polypharmacy thresholds:
      - Standard polypharmacy: 5+ medications
      - Severe/complex polypharmacy: 10+ medications

      Enriched with BNF codes and medication names for current medications.

    columns:
      - name: person_id
        description: Person identifier
        data_tests:
          - not_null
          - unique
          - relationships:
              to: ref('int_patient_person_unique')
              field: person_id

      - name: medication_count
        description: Count of distinct current polypharmacy-scope medications
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: medication_bnf_list
        description: Array of BNF codes for current medications
        data_tests:
          - not_null

      - name: medication_name_list
        description: Array of BNF medication names for current medications
        data_tests:
          - not_null

      - name: is_polypharmacy_5plus
        description: Standard polypharmacy flag (5+ medications)
        data_tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: is_polypharmacy_10plus
        description: Severe/complex polypharmacy flag (10+ medications)
        data_tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: polypharmacy_status_date
        description: Earliest order date among current medications
        data_tests:
          - not_null
