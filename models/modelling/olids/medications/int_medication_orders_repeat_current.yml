version: 2

models:
  - name: int_medication_orders_repeat_current
    description: |
      Latest repeat medication orders currently active based on supply duration.

      Grain: One row per person Ã— medication (latest order only, current medications)

      Inclusion criteria:
      - Repeat prescriptions only (authorisation_type = '182918009' from REPEAT_PRESCRIPTION cluster)
      - Order date + duration >= today (current supply not expired)
      - Order date <= today (exclude future orders)
      - Latest order per person-medication combination
      - Duration defaults to 28 days if NULL

      Uses medication_order table as source of truth for dispensing events and duration.

    columns:
      - name: person_id
        description: Person identifier
        data_tests:
          - not_null

      - name: mapped_concept_code
        description: SNOMED CT code for the medication
        data_tests:
          - not_null

      - name: latest_order_date
        description: Date of most recent medication order
        data_tests:
          - not_null

      - name: latest_duration
        description: Duration in days for most recent order (NULL defaults to 28 days in currency calculation)
