version: 2

models:
  - name: int_polypharmacy_medications_current
    description: |
      Current repeat medications within polypharmacy scope using exclusion-based filtering.

      Grain: One row per person Ã— medication (current polypharmacy-scope medications only)

      Inclusion criteria:
      - Current repeat prescriptions (from int_medication_orders_repeat_current)
      - Medications in polypharmacy scope (INNER JOIN with int_polypharmacy_medications_list)
      - Active supply (order date + duration >= today)

      Polypharmacy scope excludes:
      - Most of Chapter 5 (infections, except HIV 5.3.1 and hepatitis 5.3.3)
      - Chapter 9 subchapters (vitamins, minerals, nutrition)
      - Various subchapters (contraceptives, thyroid drugs, topicals, etc.)
      - Chapters 11-15, 18, 20-23 (devices, dressings, appliances)

      See int_polypharmacy_medications_list for complete exclusion details.

      Enriched with BNF details for medication identification and categorization.

    columns:
      - name: person_id
        description: Person identifier
        data_tests:
          - not_null

      - name: mapped_concept_code
        description: SNOMED CT code for the medication
        data_tests:
          - not_null

      - name: bnf_code
        description: BNF code for the medication
        data_tests:
          - not_null

      - name: bnf_chapter
        description: BNF chapter (2-digit code) - varies based on polypharmacy scope exclusions
        data_tests:
          - not_null

      - name: bnf_name
        description: BNF name/description of the medication

      - name: latest_order_date
        description: Date of most recent medication order
        data_tests:
          - not_null

      - name: latest_duration
        description: Duration in days for most recent order
    tests:
      - dbt_utils.at_least_one:
          column_name: person_id
