version: 2
models:
  - name: int_smi_diagnoses_all
    description: 'Serious mental illness diagnosis and remission observations for QOF register management.

      One row per observation using MH_COD (diagnosis) and MHREM_COD (remission) clusters. Age restrictions â‰¥18 years typically applied downstream.'
    columns:
      - name: id
        description: 'Observation identifier (not unique - same observation may appear for multiple cluster matches)'
        tests:
          - not_null

      - name: person_id
        description: 'Patient identifier'

      - name: clinical_effective_date
        description: 'Date when SMI observation was clinically effective'

      - name: concept_code
        description: 'Clinical code for SMI diagnosis or remission'

      - name: concept_display
        description: 'Human-readable description of the clinical code'

      - name: source_cluster_id
        description: 'QOF cluster identifier (MH_COD or MHREM_COD)'

      - name: is_diagnosis_code
        description: 'Flag indicating SMI diagnosis code (MH_COD cluster)'

      - name: is_resolved_code
        description: 'Flag indicating SMI remission code (MHREM_COD cluster)'

      - name: smi_observation_type
        description: 'Categorised SMI observation type (SMI Diagnosis or SMI Resolved)'

    tests:
      - dbt_utils.at_least_one:
          column_name: id
      - cluster_ids_exist:
          cluster_ids: MH_COD, MHREM_COD
