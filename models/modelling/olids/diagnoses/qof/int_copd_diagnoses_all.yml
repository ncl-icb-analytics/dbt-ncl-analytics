models:
  - name: int_copd_diagnoses_all
    description: 'COPD diagnosis and resolution observations for QOF register management.

      One row per observation using COPD_COD (diagnosis) and COPDRES_COD (resolved)
      clusters. Post-April 2023 requires spirometry confirmation (FEV1/FVC <0.7).'
    config:
      meta:
        owner:
          name: EddieDavison92
    columns:
      - name: id
        description: 'Unique identifier for the clinical observation'
        tests:
          - unique
          - not_null

      - name: person_id
        description: 'Patient identifier'

      - name: clinical_effective_date
        description: 'Date when COPD observation was clinically effective'

      - name: concept_code
        description: 'Clinical code for COPD diagnosis or resolution'

      - name: concept_display
        description: 'Human-readable description of the clinical code'

      - name: source_cluster_id
        description: 'QOF cluster identifier (COPD_COD or COPDRES_COD)'

      - name: is_diagnosis_code
        description: 'Flag indicating COPD diagnosis code (COPD_COD cluster)'

      - name: is_resolved_code
        description: 'Flag indicating COPD resolution code (COPDRES_COD cluster)'

      - name: copd_observation_type
        description: 'Categorised COPD observation type (COPD Diagnosis or COPD Resolved)'

    tests:
      - dbt_utils.at_least_one:
          column_name: id
      - cluster_ids_exist:
          cluster_ids: COPDRES_COD, COPD_COD
