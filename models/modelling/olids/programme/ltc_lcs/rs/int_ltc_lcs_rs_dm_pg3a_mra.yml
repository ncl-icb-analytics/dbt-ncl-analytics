version: 2
models:
  - name: int_ltc_lcs_rs_dm_pg3a_mra
    description: |
      Diabetes Register Priority Group 3A - Moderate Risk A identification.

      Patients on the diabetes register (excluding PG1, PG2) with HbA1c 58-75 AND any of:
      - Rule 3: MI, cerebral thrombosis, or TIA in last 12 months
      - Rule 4: eGFR 30-44
      - Rule 5: ACR > 30
      - Rule 6: ABPM BP â‰¥140/90

      Note: BP logic simplified from EMIS implementation. EMIS anchors to the date of the
      latest 1000 BP readings then checks for ABPM codes on that date. This implementation
      directly checks the latest ABPM reading against the 140/90 threshold, which is
      logically equivalent but more readable.
    config:
      meta:
        owner:
          name: EddieDavison92
    tests:
      - dbt_utils.at_least_one:
          column_name: person_id
      - valuesets_have_codes:
          valuesets:
            - on_dm_reg_priority_group_3a_mra_vs1
            - on_dm_reg_priority_group_3a_mra_vs2
            - on_dm_reg_priority_group_3a_mra_vs3
            - on_dm_reg_priority_group_3a_mra_vs4
            - on_dm_reg_priority_group_3a_mra_vs5
            - on_dm_reg_priority_group_3a_mra_vs6
    columns:
      - name: person_id
        tests:
          - not_null
          - unique
