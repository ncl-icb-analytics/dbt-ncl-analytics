version: 2
models:
  - name: int_ltc_lcs_rs_copd_pg3_mr
    description: |
      COPD Register Priority Group 2 - High Risk.

      Patients on COPD register (excluding PG1 HRC and PG2 HR) meeting any inclusion rule:
      - Rule 2: FEV1 >= 50 and < 80 (inclusion)
      - Rule 3: MRC Breathlessness Scale: grade 2 or 3 (inclusion)
      - Rule 4: 1 COPD exacerbation within last 12 months OR 
                medication issues (any of Amoxicillin, Amoxicillin Trihydrate,
                Doxycycline, Doxycycline Hyclate, Doxycycline Monohydrate, Erythromycin, 
                Erythromycin (As Stearate), Erythromycin Ethyl Succinate, Clarithromycin) 
                within last 12 months OR
                Medication issues (any of Prednisolone, Prednisolone Sodium Phosphate, 
                Prednisolone Steaglate) within last 12 months OR 
                Medication issues (any of Azithromycin, Azithromycin) within last 12 months
        - Rule 5: Medication issues (any of Trimbow, Trelegy Ellipta) within last 6 months
        - Rule 6: Medication issues (any of Beclometasone Dipropionate, Budesonide, Ciclesonide, 
                  Fluticasone Furoate, Fluticasone Propionate, Mometasone Furoate) within last 6 months AND
                  Medication issues (any of Aclidinium Bromide, Glycopyrronium bromide 55microgram 
                  inhalation powder capsules with device, Seebri Breezhaler 44microgram inhalation 
                  powder capsules with device (Novartis Pharmaceuticals UK Ltd) ...etc) within last 6 months AND
                  Medication issues ( Bambuterol Hydrochloride, Formoterol Fumarate, Indacaterol, Olodaterol, 
                  Salmeterol Xinafoate, Umeclidinium Bromide, Beclometasone 100micrograms/dose / Formoterol 6micrograms/dose dry powder inhaler, 
                  Beclometasone 100micrograms/dose / Formoterol 6micrograms/dose inhaler CFC free ...etc) within last 6 months
    config:
      meta:
        owner:
          name: Peter Shakeshaft
    tests:
      - dbt_utils.at_least_one:
          column_name: person_id
      - valuesets_have_codes:
          valuesets:
            - on_copd_reg_pg3_mr_vs1
            - on_copd_reg_pg3_mr_vs2
            - on_copd_reg_pg3_mr_vs3
            - on_copd_reg_pg3_mr_vs4
            - on_copd_reg_pg3_mr_vs5
            - on_copd_reg_pg3_mr_vs6
            - on_copd_reg_pg3_mr_vs7
            - on_copd_reg_pg3_mr_vs8
            - on_copd_reg_pg3_mr_vs9
            - on_copd_reg_pg3_mr_vs10
            - on_copd_reg_pg3_mr_vs11
            - on_copd_reg_pg3_mr_vs12
            - on_copd_reg_pg3_mr_vs13
            - on_copd_reg_pg3_mr_vs14
            - on_copd_reg_pg3_mr_vs15
    columns:
      - name: person_id
        tests:
          - not_null
          - unique