version: 2

models:
  - name: int_pds_olids_practice_registration_comparison
    description: |
      Compares OLIDS all registration counts against PDS to identify discrepancies.

      Acceptance Criteria (Updated to match EMIS):
      - Per-practice: <2% variance OR fewer than 5 persons difference (whichever is greater)

      Uses PDS merger handling to account for NHS number changes.
      Includes all registration types (not filtered to Regular only like EMIS).

    columns:
      - name: practice_code
        description: GP practice ODS code

      - name: practice_name
        description: GP practice name

      - name: pds_unmerged_persons
        description: Count of distinct persons in PDS before merger handling

      - name: pds_merged_persons
        description: Count of distinct persons in PDS after NHS number merger handling (recommended for comparison)

      - name: olids_patient_count
        description: Count of distinct patients with registration episodes in OLIDS

      - name: difference
        description: Difference between OLIDS and PDS (signed, can be negative)

      - name: percent_difference
        description: Percentage difference (signed, can be negative)

      - name: absolute_difference
        description: Absolute difference between OLIDS and PDS

      - name: absolute_percent_difference
        description: Absolute percentage difference

      - name: meets_acceptance_criteria
        description: Boolean flag indicating if practice meets acceptance criteria (<2% variance OR <5 persons difference)

      - name: has_significant_discrepancy
        description: Legacy flag for >=20% discrepancy (deprecated, kept for backwards compatibility)

      - name: validation_methodology
        description: Description of the validation test applied (PDS All Registration Types Comparison with thresholds)
