version: 2

models:
  - name: int_sus_op_procedure_hrg
    description: "All bundled and unbundled HRGs recorded for individuals in an outpatient setting. Grain: HRG code"
    tests:
    - dbt_utils.unique_combination_of_columns:
        combination_of_columns:
        - visit_occurrence_id
        - problem_order
        - source_concept_code
        config:
          severity: error
          error_if: ">1000"
          warn_if: ">10"
    - dbt_expectations.expect_table_row_count_to_be_between:
        min_value: 1
    columns:
      - name: procedure_id
        data_type: varchar
        description: "Unique identifier of procedure (surrogate key) using appointment identifier, code order and code"

      - name: date
        data_type: timestamp_ntz
        description: "Date of appointment"

      - name: visit_occurrence_id
        data_type: number
        description: "Unique identifier of appointment (primarykey_id in raw sus tables)"

      - name: visit_occurrence_type
        data_type: varchar
        description: "Indicator of source dataset"

      - name: problem_order
        data_type: number
        description: "Unbundled HRG identifier within the appointment. Used in combination with the [PRIMARYKEY_ID] to uniquely identify the row in the child table. Value of 0 indicates core HRG from appointments"

      - name: sk_patient_id
        data_type: varchar
        description: "Unique patient identifer linkage across commissioning datasets"
        tests:
        - not_null

      - name: organisation_id
        data_type: varchar
        description: "The Organisation Code of the Organisation acting as a Health Care Provider as issued by the Organisation Data Service (ODS). This field represents the organisation receiving payment for the associated activity"

      - name: organisation_name
        data_type: varchar
        description: "The name associated with the ODS code for the Health Care Provider"

      - name: site_id
        data_type: varchar
        description: "Site Code of Treatment is the Organisation Code of the location where the patient was treated, i.e. it should enable the treating Organisation site to be identified."

      - name: site_name
        data_type: varchar
        description: "The name associated with the site id code"

      - name: source_concept_code
        data_type: varchar
        description: "HRG code. Either: Unbundled HRG code or the core HRG derived by SUS as a result of HRG grouping and used for tariff application"
        tests:
        - not_null

      - name: concept_name
        data_type: varchar
        description: "HRG description as listed in the HRG dictionary"

      - name: concept_vocabulary
        data_type: varchar
        description: "Code type shown"

      - name: hrg_chapter
        data_type: varchar
        description: "Descriptive broad category of HRG treatment/conditions"

      - name: hrg_subchapter
        data_type: varchar
        description: "Descriptive sub-category of HRG treatment/conditions"