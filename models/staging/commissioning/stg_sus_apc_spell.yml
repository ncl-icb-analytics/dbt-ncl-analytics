models:
  - name: stg_sus_apc_spell
    description: 'Admitted Patient Care (APC) spells from SUS data.

      One row per spell.

      '
    config:
      meta:
        owner:
          name: EddieDavison92
    columns:
      - name: primarykey_id
        description: Unique identifier for the spell (PRIMARYKEY_ID)
        tests:
          - not_null
          - unique
      - name: sk_patient_id
      - name: spell_care_location_site_code_of_treatment
      - name: spell_admission_date
      - name: spell_admission_method
      - name: spell_admission_patient_classification
      - name: spell_discharge_date
      - name: spell_discharge_length_of_hospital_stay
      - name: spell_commissioning_service_agreement_provider
      - name: spell_commissioning_grouping_core_hrg
      - name: spell_clinical_coding_grouper_derived_primary_diagnosis
      - name: spell_clinical_coding_grouper_derived_secondary_diagnosis
      - name: spell_clinical_coding_grouper_derived_dominant_procedure
      - name: spell_admission_admission_sub_type
      - name: spell_admission_admission_type
  # Spec Comm
      - name: spec_comm
      - name: spell_commissioning_tariff_calculation_final_price
      

    tests:
      - elementary.volume_anomalies:
          timestamp_column: 'spell_admission_date'
          description: "Detects anomalous daily row counts for APC spells."

      - elementary.dimension_anomalies:
          dimensions: 
            - 'SPELL_COMMISSIONING_SERVICE_AGREEMENT_PROVIDER' 
          timestamp_column: 'spell_admission_date'
          sensitivity: 3  # Default is 3 (standard deviations). Adjust to 2 for stricter alerts
          description: "Monitors for missing or unusual volumes from specific Trusts."
    
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1
