version: 2
models:
  - name: fct_person_diabetes_triple_target
    description: 'Diabetes triple target achievement tracking for clinical quality
      monitoring.

      One row per person on diabetes register.

      Target Criteria:

      • HbA1c ≤58 mmol/mol (QOF standard for glycaemic control)

      • Blood pressure <130/80 mmHg (NICE guideline for diabetes)

      • Total cholesterol <5 mmol/L (cardiovascular risk management)

      Purpose: Supports diabetes care quality assessment and identification of patients
      requiring intensified management to achieve clinical targets.'

    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1

    config:
      meta:
        indicator:
          id: "DM_TRIPLE_TARGET"
          type: "MEASURE"
          category: "DIABETES_QUALITY"
          clinical_domain: "Cardiometabolic"
          name_short: "Diabetes Triple Target Achievement"
          description_short: "Diabetes care quality assessment using HbA1c ≤58 mmol/mol,
            BP <130/80 mmHg, cholesterol <5 mmol/L"
          description_long: >
            Diabetes care quality indicator tracking achievement of three clinical
            targets:
            HbA1c ≤58 mmol/mol for glycaemic control, blood pressure <130/80 mmHg
            for cardiovascular  protection, and total cholesterol <5 mmol/L for cardiovascular
            risk management. Supports  QOF reporting and identifies patients requiring
            intensified management.
          is_qof: false
          source_column: "triple_target_achieved"
          usage_contexts:
            - "DIABETES_CARE_MONITORING"
          code_clusters:
            - cluster_id: "DM_COD"
              category: "INCLUSION"
            - cluster_id: "DMTYPE1_COD"
              category: "INCLUSION"
            - cluster_id: "DMTYPE2_COD"
              category: "INCLUSION"
            - cluster_id: "HBA1C_COD"
              category: "CALCULATION"
            - cluster_id: "BP_COD"
              category: "CALCULATION"
            - cluster_id: "CHOL_COD"
              category: "CALCULATION"
          thresholds:
            # HbA1c Target
            - population_group: "DIABETES"
              threshold_type: "HBA1C_TARGET"
              threshold_value: "58"
              threshold_operator: "AT_OR_BELOW"
              threshold_unit: "mmol/mol"
              description: "QOF HbA1c target for glycaemic control"
              sort_order: 1
            # Blood Pressure Target
            - population_group: "DIABETES"
              threshold_type: "BP_TARGET_SYSTOLIC"
              threshold_value: "130"
              threshold_operator: "BELOW"
              threshold_unit: "mmHg"
              description: "Systolic BP target for diabetes"
              sort_order: 2
            - population_group: "DIABETES"
              threshold_type: "BP_TARGET_DIASTOLIC"
              threshold_value: "80"
              threshold_operator: "BELOW"
              threshold_unit: "mmHg"
              description: "Diastolic BP target for diabetes"
              sort_order: 3
            # Cholesterol Target
            - population_group: "DIABETES"
              threshold_type: "CHOLESTEROL_TARGET"
              threshold_value: "5"
              threshold_operator: "BELOW"
              threshold_unit: "mmol/L"
              description: "Total cholesterol target for cardiovascular risk management"
              sort_order: 4

        owner:
          name: EddieDavison92
    columns:
      - name: person_id
        description: Unique person identifier
        tests:
          - unique
          - not_null

      - name: diabetes_type
        description: Diabetes type classification (Type 1, Type 2, Unknown)

      - name: latest_hba1c_date
        description: Date of most recent HbA1c measurement

      - name: latest_hba1c_value
        description: Most recent HbA1c value

      - name: hba1c_unit
        description: Unit for HbA1c measurement (mmol/mol or %)

      - name: hba1c_clinical_category
        description: Clinical category for HbA1c level

      - name: latest_bp_date
        description: Date of most recent blood pressure measurement

      - name: latest_systolic
        description: Most recent systolic blood pressure (mmHg)

      - name: latest_diastolic
        description: Most recent diastolic blood pressure (mmHg)

      - name: latest_chol_date
        description: Date of most recent cholesterol measurement

      - name: latest_chol_value
        description: Most recent total cholesterol value (mmol/L)

      - name: hba1c_type
        description: HbA1c measurement standard (IFCC or DCCT)

      - name: hba1c_in_target_range
        description: Whether HbA1c meets QOF target (≤58 mmol/mol)

      - name: bp_in_target_range
        description: Whether blood pressure meets target (<130/80 mmHg)

      - name: cholesterol_in_target_range
        description: Whether cholesterol meets target (<5 mmol/L)

      - name: triple_target_achieved
        description: Whether all three targets are achieved

      - name: number_of_targets_achieved
        description: Count of targets achieved (0-3)

      - name: has_all_measurements
        description: Whether person has all three measurements available
