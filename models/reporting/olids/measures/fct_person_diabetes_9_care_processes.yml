models:
  - name: fct_person_diabetes_9_care_processes
    description: 'Diabetes 9 care processes achievement for QOF reporting.

      One row per person on diabetes register with completion status for all 9 care
      processes (8 standard plus retinal screening) within 12 months.'

    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1

    columns:
      - name: person_id
        tests:
          - unique
          - not_null

    config:
      meta:
        indicator:
          id: "DM_9_CARE_PROCESSES"
          type: "MEASURE"
          category: "DIABETES_QUALITY"
          clinical_domain: "Cardiometabolic"
          name_short: "Diabetes 9 Care Processes"
          description_short: "QOF diabetes care processes including retinal screening
            within 12 months"
          description_long: >
            Tracks completion of 9 diabetes care processes required for QOF reporting:
            the 8 standard care processes (HbA1c, blood pressure, cholesterol, creatinine,
            ACR, foot
            examination, BMI, smoking status) plus retinal screening for diabetic
            retinopathy. All  measurements and screenings must be completed within
            12 months for QOF compliance.
            Supports diabetes care pathway monitoring and quality improvement.
          is_qof: true
          source_column: "care_processes_completed_count"
          usage_contexts:
            - "DIABETES_CARE_MONITORING"
            - "QOF"
          code_clusters:
            - cluster_id: "DM_COD"
              category: "INCLUSION"
            - cluster_id: "DMTYPE1_COD"
              category: "INCLUSION"
            - cluster_id: "DMTYPE2_COD"
              category: "INCLUSION"
            - cluster_id: "HBA1C_COD"
              category: "CALCULATION"
            - cluster_id: "BP_COD"
              category: "CALCULATION"
            - cluster_id: "CHOL_COD"
              category: "CALCULATION"
            - cluster_id: "CREAT_COD"
              category: "CALCULATION"
            - cluster_id: "ACR_COD"
              category: "CALCULATION"
            - cluster_id: "FOOT_COD"
              category: "CALCULATION"
            - cluster_id: "BMIVAL_COD"
              category: "CALCULATION"
            - cluster_id: "SMOKE_COD"
              category: "CALCULATION"
            - cluster_id: "RETINAL_COD"
              category: "CALCULATION"
          thresholds:
            # Process completion timeframes
            - population_group: "DIABETES"
              threshold_type: "PROCESS_COMPLETION_PERIOD"
              threshold_value: "12"
              threshold_operator: "WITHIN"
              threshold_unit: "months"
              description: "QOF requirement for all care processes within 12 months"
              sort_order: 1
            - population_group: "DIABETES"
              threshold_type: "FULL_COMPLIANCE"
              threshold_value: "9"
              threshold_operator: "EQUALS"
              threshold_unit: "processes"
              description: "All 9 care processes completed for full QOF compliance"
              sort_order: 2
            - population_group: "DIABETES"
              threshold_type: "RETINAL_SCREENING_PERIOD"
              threshold_value: "12"
              threshold_operator: "WITHIN"
              threshold_unit: "months"
              description: "Diabetic retinopathy screening within 12 months"
              sort_order: 3
        owner:
          name: EddieDavison92
