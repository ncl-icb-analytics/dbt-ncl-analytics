version: 2

models:
  - name: fct_person_medications_recent
    description: |
      Medications prescribed within the last 30 days and last year per person.

      Person-level snapshot of recent medication prescriptions with counts and active ingredient analysis.
      Includes all medication orders (not just repeat prescriptions) from the last 30 days and last year.

      Active Ingredient Analysis:
      - Uses VTM (Virtual Therapeutic Moiety) from BNF/dm+d to identify unique active ingredients
      - VTM represents the active ingredient/therapeutic moiety in the UK dm+d classification system
      - Medications without VTM mapping (NULL vtm_code) are excluded from active ingredient counts
      - Unique medication count uses medication names (BNF name or original medication name)

      Grain: One row per person with medications in last 30 days or last year

    config:
      meta:
        owner:
          name: Emily Baldwin
    columns:
      - name: person_id
        description: Person identifier
        data_tests:
          - not_null
          - unique
          - relationships:
              to: ref('dim_person')
              field: person_id

      - name: medications_recent_30d
        description: Array of medication objects for prescriptions in last 30 
          days. Each object contains 'medication_name' and 'prescription_count'.
          Empty array if no medications in last 30 days.
        data_tests:
          - not_null

      - name: total_prescriptions_30d
        description: Total count of prescription orders in the last 30 days
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: unique_medication_count_30d
        description: Count of distinct medication names prescribed in the last 
          30 days
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: unique_active_ingredient_count_30d
        description: Count of distinct active ingredients (VTMs) prescribed in 
          the last 30 days. Medications without VTM mapping are excluded from 
          this count.
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: medications_recent_12mo
        description: Array of medication objects for prescriptions in last year 
          (365 days). Each object contains 'medication_name' and 
          'prescription_count'. Empty array if no medications in last year.
        data_tests:
          - not_null

      - name: total_prescriptions_12mo
        description: Total count of prescription orders in the last year (365 
          days)
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: unique_medication_count_12mo
        description: Count of distinct medication names prescribed in the last 
          year (365 days)
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: unique_active_ingredient_count_12mo
        description: Count of distinct active ingredients (VTMs) prescribed in 
          the last year (365 days). Medications without VTM mapping are excluded
          from this count.
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
