models:
  - name: dim_valproate_araf
    description: |
      Annual Risk Acknowledgement Form (ARAF) events aggregation for valproate safety monitoring.

      **PURPOSE:**
      Tracks ARAF completion status for patients on valproate, supporting MHRA teratogen risk management requirements.

      **KEY FEATURES:**

      - **ARAF Form Types Supported:**
        - Old ARAF (SNOMED: 1366401000000107) - Legacy annual risk acknowledgement form
        - New ARAF (SNOMED: 2078951000000106) - Current annual risk acknowledgement form

      - **Date Tracking:**
        - Separate tracking of old vs new ARAF form dates
        - Overall latest ARAF date calculation (prioritises most recent between form types)
        - Lookback period compliance based on valproate programme codes

      - **Form Status Information:**
        - Boolean flags for each ARAF form type presence
        - Formatted info strings showing actual completion dates for each form type
        - Compliance status based on lookback requirements

      **BUSINESS RULES:**

      - Only includes persons with at least one ARAF event meeting lookback criteria
      - `latest_araf_overall_date` uses legacy logic: picks most recent between old/new forms
      - Info strings show "Yes (DD/MM/YYYY)" for completed forms, "No" for missing forms
      - All observation IDs, concept codes, and displays preserved for audit trail

      One row per person with any ARAF events meeting programme criteria.

    config:
      meta:
        owner:
          name: EddieDavison92
    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1

    columns:
      - name: person_id
        tests:
          - unique
          - not_null
