version: 2

models:
  - name: fct_flu_eligibility
    description: 'Flu vaccination eligibility determination across all eligibility pathways.

      Grain: One row per person per campaign per risk group they qualify for

      Contains:
      • Person demographics and age calculations
      • Eligibility category and specific risk group
      • Qualifying event dates and priority ranking
      • Campaign-specific eligibility rules

      Note: People eligible for multiple risk groups appear in multiple rows'
    
    config:
      meta:
        indicator:
          id: "FLU_ELIGIBILITY_OVERALL"
          type: "PROGRAMME"
          category: "FLU"
          clinical_domain: "Programme Management"
          name_short: "Flu Eligibility Overall"
          description_short: "Overall flu vaccination eligibility across all pathways"
          description_long: >
            Flu vaccination eligibility determination combining all eligibility
            pathways including age-based criteria (≥65 years, children), clinical conditions
            (respiratory, cardiovascular, diabetes, etc.), at-risk groups (pregnancy, immunosuppression,
            care home residents), and occupational groups (healthcare workers, unpaid carers).
            Provides single source of truth for flu programme planning and vaccination delivery.
          is_qof: false
          source_column: "is_eligible"
          sort_order: "FLU_100_ELIGIBILITY_OVERALL"
          usage_contexts:
            - "COVID_AND_FLU_DASHBOARD"
            - "FLU_REPORTING"
          code_clusters:
            - cluster_id: "FLUVAX_COD"
              category: "INCLUSION"
          thresholds:
            - population_group: "CHILDREN"
              threshold_type: "AGE_ELIGIBILITY"
              threshold_value: "6"
              threshold_operator: "AT_OR_ABOVE"
              threshold_unit: "months"
              description: "Minimum age for flu vaccination"
              sort_order: 1
            - population_group: "ADULTS"
              threshold_type: "AGE_ELIGIBILITY"
              threshold_value: "65"
              threshold_operator: "AT_OR_ABOVE"
              threshold_unit: "years"
              description: "Age-based eligibility threshold"
              sort_order: 2
    
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - person_id
            - risk_group
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1

    columns:
      - name: person_id
        description: Unique person identifier
        tests:
          - not_null

      - name: campaign_id
        description: Flu campaign identifier (e.g., flu_2024_25)
        tests:
          - not_null
        
      - name: campaign_year
        description: Campaign year for reporting
        
      - name: campaign_category
        description: Eligibility category for this person
        
      - name: is_eligible
        description: Whether person is eligible for flu vaccination
        
      - name: eligibility_reason
        description: Primary reason for eligibility
        
      - name: age_at_campaign_start
        description: Person's age at campaign start date
        
      - name: has_clinical_condition
        description: Whether person has qualifying clinical condition
        
      - name: is_pregnant
        description: Whether person is pregnant during campaign
        
      - name: is_healthcare_worker
        description: Whether person is a healthcare worker
        
      - name: is_care_home_resident
        description: Whether person is a care home resident