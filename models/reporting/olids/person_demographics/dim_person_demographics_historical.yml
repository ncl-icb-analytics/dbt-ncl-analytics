version: 2

models:
  - name: dim_person_demographics_historical
    description: 'Historical Person Demographics - SCD Type 2

      Tracks changes to demographic attributes over time using SCD-2 pattern.
      Pure assembly model joining upstream building blocks without duplicating calculations.

      Grain: One row per person per change period (not per month)

      Key Features:

      • SCD-2 structure with effective_start_date, effective_end_date, is_current, period_sequence

      • Tracks changes in: practice registration, ethnicity, address/geography

      • No age fields (age is derived, not an attribute - calculate in consuming models using calculate_age_attributes macro)

      • Change detection: new period created when practice OR ethnicity OR address changes

      • Pure assembly: joins from int_patient_registrations, int_ethnicity_all, int_person_geography, dim_person_birth_death, etc.

      Storage Efficiency:

      • ~85-90% more efficient than person-month grain

      • Change-based periods (typically 5-10 per person) vs monthly snapshots

      Inclusion Criteria:

      • Must have valid birth_date_approx (required for age calculations in consuming models)

      • Must have registration history (practice_code IS NOT NULL)

      Known Limitations:

      • Address fields use current address for all periods (address SCD dates not yet populated in int_person_geography)

      For monthly snapshots with conditions, use person_month_analysis_base.
      For current state only, use dim_person_demographics.'

    columns:
      - name: person_id
        description: 'Unique person identifier'
        tests:
          - not_null

      - name: sk_patient_id
        description: 'Surrogate key for patient record'

      - name: effective_start_date
        description: 'Start date of this demographic period (SCD-2)'
        tests:
          - not_null

      - name: effective_end_date
        description: 'End date of this demographic period (NULL if current, SCD-2)'

      - name: is_current
        description: 'Flag indicating if this is the current period for the person (SCD-2)'
        tests:
          - not_null

      - name: period_sequence
        description: 'Sequential number of periods for each person (1, 2, 3, ...)'
        tests:
          - not_null

      - name: is_active
        description: 'Active registration status during this period'
        tests:
          - not_null

      - name: is_deceased
        description: 'Death status flag'
        tests:
          - not_null

      - name: is_dummy_patient
        description: 'Dummy patient record flag'
        tests:
          - not_null

      - name: inactive_reason
        description: 'Reason for inactive status (Deceased, Registration ended, or NULL)'

      - name: birth_year
        description: 'Birth year'

      - name: birth_month
        description: 'Birth month'

      - name: birth_date_approx
        description: 'Approximate birth date (use this with effective_start_date to calculate age)'

      - name: birth_date_approx_end_of_month
        description: 'Birth date approximated to end of birth month'

      - name: death_year
        description: 'Death year if deceased'

      - name: death_month
        description: 'Death month if deceased'

      - name: death_date_approx
        description: 'Approximate death date if deceased'

      - name: gender
        description: 'Gender'

      - name: ethnicity_category
        description: 'Ethnicity category during this period'

      - name: ethnicity_subcategory
        description: 'Ethnicity subcategory during this period'

      - name: ethnicity_granular
        description: 'Detailed ethnicity during this period'

      - name: ethnicity_category_sort
        description: 'Sort order for ethnicity category'

      - name: ethnicity_display_sort_key
        description: 'Display sort key for ethnicity'

      - name: main_language
        description: 'Main language'

      - name: language_type
        description: 'Language type classification'

      - name: interpreter_type
        description: 'Type of interpreter needed'

      - name: interpreter_needed
        description: 'Interpreter needed flag'

      - name: practice_code
        description: 'Practice code during this period'

      - name: practice_name
        description: 'Practice name during this period'

      - name: registration_start_date
        description: 'Start date of practice registration'

      - name: registration_end_date
        description: 'End date of practice registration (NULL if active)'

      - name: pcn_code
        description: 'Primary Care Network code'

      - name: pcn_name
        description: 'Primary Care Network name'

      - name: pcn_name_with_borough
        description: 'PCN name with borough prefix'

      - name: icb_code
        description: 'Integrated Care Board (ICB) code where patient was registered (practice-based)'

      - name: icb_name
        description: 'Integrated Care Board (ICB) name where patient was registered (practice-based)'

      - name: borough_registered
        description: 'Practice borough where patient was registered'

      - name: practice_postcode
        description: 'Practice postcode'

      - name: practice_lsoa
        description: 'Practice LSOA'

      - name: practice_msoa
        description: 'Practice MSOA'

      - name: practice_latitude
        description: 'Practice latitude coordinate'

      - name: practice_longitude
        description: 'Practice longitude coordinate'

      - name: neighbourhood_registered
        description: 'Practice neighbourhood classification'

      - name: postcode_hash
        description: 'Patient residential address postcode hash during this period'

      - name: uprn_hash
        description: 'Patient address UPRN hash (placeholder)'

      - name: household_id
        description: 'Household identifier (placeholder)'

      - name: icb_code_resident
        description: 'ICB code where patient resided during this period'

      - name: icb_resident
        description: 'ICB name where patient resided during this period'

      - name: local_authority_code
        description: 'Local Authority code where patient resided during this period'

      - name: local_authority_name
        description: 'Local Authority name where patient resided during this period'

      - name: borough_resident
        description: 'London borough where patient resided during this period'

      - name: is_london_resident
        description: 'Flag indicating if patient resided in Greater London'

      - name: london_classification
        description: 'London area classification (NCL, Other London, Outside London)'

      - name: lsoa_code_21
        description: 'LSOA 2021 code where patient resided during this period'

      - name: lsoa_name_21
        description: 'LSOA 2021 name where patient resided during this period'

      - name: ward_code
        description: 'Electoral Ward 2025 code where patient resided during this period'

      - name: ward_name
        description: 'Electoral Ward 2025 name where patient resided during this period'

      - name: imd_decile_19
        description: 'IMD 2019 decile (1=most deprived, 10=least deprived)'

      - name: imd_quintile_19
        description: 'IMD 2019 quintile text labels'

      - name: imd_quintile_numeric_19
        description: 'IMD 2019 numeric quintile (1=most deprived, 5=least deprived)'

      - name: neighbourhood_resident
        description: 'NCL neighbourhood classification'

    tests:
      - dbt_utils.unique_combination_of_columns:
          name: dim_person_demographics_historical_unique_person_period
          combination_of_columns:
            - person_id
            - effective_start_date
