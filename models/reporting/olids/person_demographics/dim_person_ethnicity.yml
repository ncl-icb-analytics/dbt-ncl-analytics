version: 2
models:
  - name: dim_person_ethnicity
    description: 'Latest recorded ethnicity for all persons with three-level classification
      hierarchy.

      Key Features:

      • One row per person with most recent ethnicity recording

      • Three-tier classification: Category > Subcategory > Granular detail

      • Prioritisation logic: non-deprioritised records, higher specificity, then
      most recent

      • Defaults to "Not Recorded" for persons without ethnicity data

      • Includes sorting helpers for consistent display ordering

      Purpose: Supports ethnicity analysis, health equity monitoring, and demographic
      profiling.'

    config:
      meta:
        indicator:
          id: "DEMO_ETHNICITY"
          type: "DEMOGRAPHIC_ATTRIBUTE"
          category: "DEMOGRAPHICS"
          clinical_domain: "Demographics"
          name_short: "Ethnicity"
          description_short: "Three-tier ethnicity classification from latest clinical
            recording"
          description_long: >
            Ethnicity classification based on most recent clinical observations with
            three-tier
            hierarchy: Category > Subcategory > Granular detail. Uses ETHNICITY_CODES
            reference
            table mapping to NHS Digital 2016+ ethnicity categories. Prioritises non-deprioritised
            records and higher specificity, then most recent date. Supports health
            equity monitoring,
            population analysis, and demographic profiling.
          is_qof: false
          source_column: "ethnicity_category"
          sort_order: "DEMO_1_ETHNICITY"
          usage_contexts:
            - "POPULATION_HEALTH_NEEDS_DASHBOARD"
            - "DEMOGRAPHICS"
            - "HEALTH_EQUITY"
          code_clusters:
            - cluster_id: "ETH2016AI_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016AP_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016AB_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016AC_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016AO_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016MWA_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016OA_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016BA_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016MWBA_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016BC_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016MWBC_COD"
              category: "INCLUSION"
            - cluster_id: "ETH2016BO_COD"
              category: "INCLUSION"

        owner:
          name: EddieDavison92
    columns:
      - name: person_id
        description: 'Unique identifier for the person'
        tests:
          - not_null
          - unique

      - name: sk_patient_id
        description: 'Surrogate key for patient record (NULL if no ethnicity recorded)'
      - name: latest_ethnicity_date
        description: 'Clinical effective date of latest ethnicity recording'

      - name: concept_id
        description: 'SNOMED concept ID for ethnicity ("Not Recorded" if none available)'
        tests:
          - not_null

      - name: snomed_code
        description: 'SNOMED code for ethnicity ("Not Recorded" if none available)'
        tests:
          - not_null

      - name: term
        description: 'SNOMED term description for ethnicity ("Not Recorded" if none
          available)'
        tests:
          - not_null

      - name: ethnicity_category
        description: 'Main ethnicity category (e.g., White, Asian, Black, Mixed, Other)'
        tests:
          - not_null

      - name: ethnicity_subcategory
        description: 'Ethnicity subcategory within main category'
        tests:
          - not_null

      - name: ethnicity_granular
        description: 'Most detailed ethnicity classification available'
        tests:
          - not_null

      - name: deprioritise_flag
        description: 'Flag indicating if this ethnicity record should be deprioritised
          in selection'

      - name: preference_rank
        description: 'Preference ranking for ethnicity record selection (lower = higher
          priority)'

      - name: category_sort
        description: 'Sort order for ethnicity category display'

      - name: display_sort_key
        description: 'Combined sort key for consistent ethnicity display ordering'

