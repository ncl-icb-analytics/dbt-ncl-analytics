version: 2

models:
  - name: dim_person_demographics
    description: 'Current Person Demographics Dimension Table

      Provides current demographic snapshot for ALL persons with registration history.
      Thin wrapper over dim_person_demographics_historical selecting only current periods.

      Grain: One row per person (current demographics only)

      Key Features:

      • Derived from dim_person_demographics_historical (is_current = TRUE)

      • Includes ALL persons with registration history (active and inactive)

      • Age calculated dynamically for current date using calculate_age_attributes macro

      • is_active flag shows current registration status

      • Practice details show latest/current registration

      Inclusion Criteria:

      • Must have valid birth_date_approx (required for age calculation)

      • Must have registration history (practice_code IS NOT NULL in historical)

      For historical change tracking, use dim_person_demographics_historical.
      For monthly snapshots with conditions, use person_month_analysis_base.'

    columns:
      - name: person_id
        description: 'Unique person identifier'
        tests:
          - not_null
          - unique

      - name: sk_patient_id
        description: 'Surrogate key for patient record'

      - name: is_active
        description: 'Current registration status'
        tests:
          - not_null

      - name: is_deceased
        description: 'Death status flag'
        tests:
          - not_null

      - name: is_dummy_patient
        description: 'Dummy patient record flag'
        tests:
          - not_null

      - name: inactive_reason
        description: 'Reason for inactive status (Deceased, Registration ended, No registration history, or NULL)'

      - name: birth_year
        description: 'Birth year'

      - name: birth_date_approx
        description: 'Approximate birth date (mid-month)'
        tests:
          - not_null

      - name: birth_date_approx_end_of_month
        description: 'Birth date approximated to end of birth month'

      - name: death_year
        description: 'Death year if deceased'

      - name: death_date_approx
        description: 'Approximate death date if deceased'

      - name: age
        description: 'Current age in years (or age at death)'

      - name: age_at_least
        description: 'Conservative age calculation using end of birth month'

      - name: age_band_5y
        description: '5-year age bands (0-4, 5-9, 10-14, ..., 80-84, 85+)'

      - name: age_band_10y
        description: '10-year age bands (0-9, 10-19, 20-29, ..., 70-79, 80+)'

      - name: age_band_nhs
        description: 'NHS Digital age bands (0-4, 5-14, 15-24, 25-34, 35-44, 45-54, 55-64, 65-74, 75-84, 85+)'

      - name: age_band_ons
        description: 'ONS age bands (0-4, 5-9, 10-14, 15-19, 20-24, 25-29, ..., 80-84, 85+)'

      - name: age_life_stage
        description: 'Life stage categories (Infant, Toddler, Child, Adolescent, Young Adult, Adult, Senior, Elderly, Very Elderly)'

      - name: is_primary_school_age
        description: 'Flag indicating primary school age (Reception to Year 6)'
        tests:
          - not_null

      - name: is_secondary_school_age
        description: 'Flag indicating secondary school age (Year 7 to Year 13)'
        tests:
          - not_null

      - name: gender
        description: 'Gender'
        tests:
          - not_null
          - accepted_values:
              values: ['Male', 'Female', 'Unknown', 'Indeterminate sex', 'Finding related to biological sex']

      - name: ethnicity_category
        description: 'Ethnicity category from latest recording'
        tests:
          - not_null

      - name: ethnicity_subcategory
        description: 'Ethnicity subcategory from latest recording'
        tests:
          - not_null

      - name: ethnicity_granular
        description: 'Detailed ethnicity from latest recording'
        tests:
          - not_null

      - name: ethnicity_category_sort
        description: 'Sort order for ethnicity category'

      - name: ethnicity_display_sort_key
        description: 'Display sort key for ethnicity'

      - name: main_language
        description: 'Main language'

      - name: language_type
        description: 'Language type classification'

      - name: interpreter_type
        description: 'Type of interpreter needed'

      - name: interpreter_needed
        description: 'Interpreter needed flag'
        tests:
          - not_null

      - name: practice_code
        description: 'Current or latest practice code'
        tests:
          - not_null

      - name: practice_name
        description: 'Current or latest practice name'

      - name: registration_start_date
        description: 'Start date of current or latest registration'

      - name: registration_end_date
        description: 'End date of current or latest registration (NULL if currently active)'

      - name: pcn_code
        description: 'Primary Care Network code'

      - name: pcn_name
        description: 'Primary Care Network name'

      - name: pcn_name_with_borough
        description: 'PCN name with borough prefix'

      - name: icb_code
        description: 'Integrated Care Board (ICB) code where patient is registered (practice-based)'

      - name: icb_name
        description: 'Integrated Care Board (ICB) name where patient is registered (practice-based)'

      - name: borough_registered
        description: 'Practice borough where patient is registered'

      - name: practice_postcode
        description: 'Practice postcode'

      - name: practice_lsoa
        description: 'Practice LSOA'

      - name: practice_msoa
        description: 'Practice MSOA'

      - name: practice_latitude
        description: 'Practice latitude coordinate'

      - name: practice_longitude
        description: 'Practice longitude coordinate'

      - name: neighbourhood_registered
        description: 'Practice neighbourhood classification'

      - name: postcode_hash
        description: 'Patient residential address postcode hash for privacy protection'

      - name: uprn_hash
        description: 'Patient address Unique Property Reference Number hash (placeholder for future use)'

      - name: household_id
        description: 'Household identifier linking persons at same address (placeholder for future use)'

      - name: icb_code_resident
        description: 'Integrated Care Board (ICB) code where patient resides (from postcode lookup)'

      - name: icb_resident
        description: 'Integrated Care Board (ICB) name where patient resides (distinct from registration ICB)'

      - name: local_authority_code
        description: 'Local Authority District 2025 code (LAD25CD) where patient resides'

      - name: local_authority_name
        description: 'Local Authority District 2025 name (LAD25NM) where patient resides'

      - name: borough_resident
        description: 'London borough where patient resides (NULL for non-London residents)'

      - name: is_london_resident
        description: 'Flag indicating if patient resides in Greater London area'

      - name: london_classification
        description: 'London area classification (NCL, Other London, Outside London)'

      - name: lsoa_code_21
        description: 'Lower Layer Super Output Area 2021 census code where patient resides'

      - name: lsoa_name_21
        description: 'Lower Layer Super Output Area 2021 census name where patient resides'

      - name: ward_code
        description: 'Electoral Ward 2025 code (WD25CD) where patient resides'

      - name: ward_name
        description: 'Electoral Ward 2025 name (WD25NM) where patient resides'

      - name: imd_decile_19
        description: 'Index of Multiple Deprivation 2019 decile (1=most deprived, 10=least deprived)'

      - name: imd_quintile_19
        description: 'Index of Multiple Deprivation 2019 quintile text labels (Most Deprived to Least Deprived)'

      - name: imd_quintile_numeric_19
        description: 'Index of Multiple Deprivation 2019 numeric quintile (1=most deprived, 5=least deprived)'

      - name: neighbourhood_resident
        description: 'NCL neighbourhood classification where patient resides (based on 2021 LSOA)'