version: 2
models:
  - name: fct_person_hypertension_register
    description: 'QOF hypertension register for patients aged 18+ with active hypertension
      diagnosis.

      One row per person with latest HTN_COD > latest HTNRES_COD, including clinical
      staging based on NICE-aligned BP thresholds.'

    tests:
      - dbt_utils.at_least_one:
          column_name: person_id

    config:
      meta:
        indicator:
          id: "HTN005"
          type: "CONDITION"
          category: "LTC"
          clinical_domain: "Cardiometabolic"
          name_short: "Hypertension"
          description_short: "QOF hypertension register"
          description_long: >
            Hypertension diagnosed using QOF criteria: Age ≥18 years with active hypertension  diagnosis
            where latest HTN code is more recent than any resolution code. Includes  clinical
            staging based on NICE-aligned BP thresholds with context-specific measurement  criteria
            (Home/ABPM vs Clinic readings). Maps to QOF indicator HTN005 (Hypertension  Register).
            Uses HTN_COD for diagnosis codes and HTNRES_COD for resolution codes.
          is_qof: true
          qof_indicator: "HTN005"
          source_column: "is_on_register"
          usage_contexts:
            - "POPULATION_HEALTH_NEEDS_DASHBOARD"
            - "QOF"
          code_clusters:
            - cluster_id: "HTN_COD"
              category: "INCLUSION"
            - cluster_id: "HTNRES_COD"
              category: "RESOLUTION"

        owner:
          name: EddieDavison92
    columns:
      - name: person_id
        description: 'Patient identifier'
        tests:
          - unique
          - not_null

      - name: age
        description: 'Current age of the patient'

      - name: is_on_register
        description: 'Flag indicating patient is on the hypertension QOF register'

      - name: earliest_diagnosis_date
        description: 'Date of earliest hypertension diagnosis'

      - name: latest_diagnosis_date
        description: 'Date of most recent hypertension diagnosis'

      - name: latest_resolved_date
        description: 'Date of most recent hypertension resolution code (if any)'

      - name: all_hypertension_concept_codes
        description: 'Array of all hypertension concept codes for this patient'

      - name: all_hypertension_concept_displays
        description: 'Array of all hypertension concept displays for this patient'

      - name: meets_age_criteria
        description: 'Flag indicating patient meets age criteria (≥18 years for hypertension
          register)'

      - name: has_active_diagnosis
        description: 'Flag indicating patient has an active hypertension diagnosis'
