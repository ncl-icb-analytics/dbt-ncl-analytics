version: 2
models:
  - name: fct_person_ckd_register
    description: >
      QOF chronic kidney disease register for patients aged 18+ with active CKD Stage 3-5 diagnosis.
      
      One row per person meeting QOF v50 criteria:
      - Has CKD Stage 3-5 diagnosis (CKD_COD)
      - NOT downstaged to Stage 1-2 (no CKD1AND2_COD after latest CKD_COD)
      - NOT resolved (no CKDRES_COD after latest CKD_COD)

    tests:
      - dbt_utils.at_least_one:
          column_name: person_id

    columns:
      - name: person_id
        description: Unique identifier for the person
        tests:
          - unique
          - not_null

      - name: latest_stage_1_2_date
        description: Date of most recent CKD Stage 1-2 code (for downstaging tracking)

      - name: all_stage_1_2_concept_codes
        description: Array of all CKD Stage 1-2 concept codes for traceability

      - name: was_downstaged
        description: Flag indicating patient has Stage 1-2 code after latest Stage 3-5 (excluded from register)

    config:
      meta:
        indicator:
          id: "CKD005"
          type: "CONDITION"
          category: "LTC"
          clinical_domain: "Nephrology"
          name_short: "Chronic Kidney Disease"
          description_short: "QOF chronic kidney disease register"
          description_long: >
            Chronic kidney disease diagnosed using QOF v50 criteria: Age â‰¥18 years with
            active CKD Stage 3-5 diagnosis where patient has not been downstaged to Stage 1-2
            or resolved. Lab data available separately for clinical monitoring.
            Maps to QOF indicator CKD005 (CKD Register).
          is_qof: true
          qof_indicator: "CKD005"
          source_column: "is_on_register"
          usage_contexts:
            - "POPULATION_HEALTH_NEEDS_DASHBOARD"
            - "QOF"
          code_clusters:
            - cluster_id: "CKD_COD"
              category: "INCLUSION"
            - cluster_id: "CKD1AND2_COD"
              category: "EXCLUSION"
            - cluster_id: "CKDRES_COD"
              category: "RESOLUTION"
        owner:
          name: EddieDavison92
