version: 2
models:
  - name: fct_person_atrial_fibrillation_register
    description: 'QOF atrial fibrillation register for patients with active AF diagnosis.

      One row per person with latest AFIB_COD > latest AFIBRES_COD or no resolution recorded.'

    tests:
      - dbt_utils.at_least_one:
          column_name: person_id

    config:
      meta:
        indicator:
          id: "AF006"
          type: "CONDITION"
          category: "LTC"
          clinical_domain: "Cardiovascular"
          name_short: "Atrial Fibrillation"
          description_short: "QOF atrial fibrillation register"
          description_long: >
            Atrial fibrillation diagnosed using QOF criteria: Active AF diagnosis where 
            latest atrial fibrillation code is more recent than any resolution code, or 
            no resolution recorded. No age restrictions apply. Maps to QOF indicator 
            AF006 (Atrial Fibrillation Register). Uses AFIB_COD for diagnosis codes and 
            AFIBRES_COD for resolution codes.
          is_qof: true
          qof_indicator: "AF006"
          source_column: "is_on_register"
          usage_contexts:
            - "POPULATION_HEALTH_NEEDS_DASHBOARD"
            - "QOF"
          code_clusters:
            - cluster_id: "AFIB_COD"
              category: "INCLUSION"
            - cluster_id: "AFIBRES_COD"
              category: "RESOLUTION"

    columns:
      - name: person_id
        description: 'Patient identifier'
        tests:
          - unique
          - not_null

      - name: age
        description: 'Current age of the patient'

      - name: is_on_register
        description: 'Flag indicating patient is on the AF QOF register'

      - name: earliest_diagnosis_date
        description: 'Date of earliest AF diagnosis'

      - name: latest_diagnosis_date
        description: 'Date of most recent AF diagnosis'

      - name: latest_resolved_date
        description: 'Date of most recent AF resolution code (if any)'

      - name: all_af_concept_codes
        description: 'Array of all AF concept codes for this patient'

      - name: all_af_concept_displays
        description: 'Array of all AF concept displays for this patient'

      - name: meets_age_criteria
        description: 'Flag indicating patient meets age criteria (always true for AF register)'

      - name: has_active_diagnosis
        description: 'Flag indicating patient has an active AF diagnosis'
