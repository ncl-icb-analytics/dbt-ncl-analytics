version: 2
models:
  - name: fct_person_learning_disability_register
    description: >
      QOF learning disability register for all patients with learning disability diagnosis.
      
      One row per person meeting QOF v50 criteria:
      - Has LD diagnosis (LD_COD)
      - NOT excluded (no LDREM_COD after latest LD_COD)
      - No age restriction (includes all ages per QOF spec)
      
      Use is_age_14_or_over column to filter for annual health check eligibility.

    tests:
      - dbt_utils.at_least_one:
          column_name: person_id

    columns:
      - name: person_id
        description: Unique identifier for the person
        tests:
          - unique
          - not_null

      - name: latest_exclusion_date
        description: Date of most recent LD exclusion code (for tracking)

      - name: all_exclusion_concept_codes
        description: Array of all LD exclusion concept codes for traceability

      - name: is_age_14_or_over
        description: Flag indicating patient is 14+ (for annual health check eligibility)

      - name: was_excluded
        description: Flag indicating patient has exclusion code after latest diagnosis

    config:
      meta:
        indicator:
          id: "LD005"
          type: "CONDITION"
          category: "LTC"
          clinical_domain: "Neurodevelopmental"
          name_short: "Learning Disability"
          description_short: "QOF learning disability register"
          description_long: >
            Learning disability register per QOF v50: Patients with LD diagnosis who have
            not been excluded. No age restriction in QOF spec. Use is_age_14_or_over column
            to filter for annual health check eligibility. Maps to QOF indicator LD005.
          is_qof: true
          qof_indicator: "LD005"
          source_column: "is_on_register"
          usage_contexts:
            - "POPULATION_HEALTH_NEEDS_DASHBOARD"
            - "QOF"
          code_clusters:
            - cluster_id: "LD_COD"
              category: "INCLUSION"
            - cluster_id: "LDREM_COD"
              category: "EXCLUSION"
        owner:
          name: EddieDavison92
