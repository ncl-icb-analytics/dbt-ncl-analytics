version: 2
models:
  - name: fct_person_copd_register
    description: 'QOF COPD register per v50 business rules specification.

      One row per person on the COPD register. Inclusion rules:
      
      Rule 1: Pre-April 2023 diagnosis - automatic inclusion
      
      Rule 2: Post-April 2023 + spirometry <0.7 within -93 to +186 days of diagnosis
      
      Rule 3: Post-April 2023 + newly registered + spirometry <0.7 within -93 to +186 days of registration
      
      Rule 4: Post-April 2023 remaining - all included per QOF v50 spec (no spirometry required)'

    tests:
      - dbt_utils.at_least_one:
          column_name: person_id

    columns:
      - name: person_id
        description: Unique identifier for the person
        tests:
          - unique
          - not_null

    config:
      meta:
        indicator:
          id: "COPD007"
          type: "CONDITION"
          category: "LTC"
          clinical_domain: "Respiratory"
          name_short: "COPD"
          description_short: "QOF COPD register"
          description_long: >
            COPD register per QOF v50 business rules. Rule 1: Automatic inclusion for
            diagnoses before 01/04/2023. Rule 2: Post-April 2023 with spirometry FEV1/FVC
            <0.7 within -93 to +186 days of diagnosis. Rule 3: Newly registered (last 12
            months) with spirometry within -93 to +186 days of registration. Rule 4: All
            remaining post-April 2023 diagnoses included per spec (no spirometry required).
            Uses COPD_COD for diagnosis and COPDRES_COD for resolution codes.
          is_qof: true
          qof_indicator: "COPD007"
          source_column: "is_on_register"
          usage_contexts:
            - "POPULATION_HEALTH_NEEDS_DASHBOARD"
            - "QOF"
          code_clusters:
            - cluster_id: "COPD_COD"
              category: "INCLUSION"
            - cluster_id: "COPDRES_COD"
              category: "RESOLUTION"
        owner:
          name: EddieDavison92
