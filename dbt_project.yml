name: 'ncl_analytics'
version: '1.20.1'
config-version: 2

profile: 'ncl_analytics'

flags:
  partial_parse: true

# Display connection info when dbt runs start
on-run-start:
  - "{{ log('ðŸ”— DBT CONNECTION: Role=' ~ target.role ~ ', Warehouse=' ~ target.warehouse ~ ', Database=' ~ target.database ~ ', Schema=' ~ target.schema ~ ', Target=' ~ target.name, info=True) }}"
  - "{% if flags.WHICH in ['run', 'build'] %}{{ ensure_governance_tags() }}{% endif %}"
  - "{% if flags.WHICH in ['run', 'build'] %}{{ create_row_count_log_table() }}{% endif %}"

target-path: "target"
clean-targets:
  - "target"
  - "dbt_modules"

model-paths: ["models"]

# ============================================================================
# CONFIGURATION VARIABLES
# ============================================================================
# Most configuration has been moved to macros/config/ for better organization.
# See macros/config/README.md for details.
#
# Variables below can still be overridden via --vars at runtime:
#   dbt run --vars '{"qof_reference_date": "2025-03-31"}'
#   dbt run --vars '{"flu_current_campaign": "Flu 2024-25"}'
# ============================================================================

vars:
  # Test audit schema (required by dbt for store_failures)
  dbt_audit_schema: "test_audit"

  # ---------------------------------------------------------------------
  # QOF Configuration (defaults in macros/config/qof_config.sql)
  # ---------------------------------------------------------------------
  # Override to set a specific reference date for point-in-time calculations
  # qof_reference_date: "2025-11-04"

  # ---------------------------------------------------------------------
  # Schema Configuration (defaults in macros/config/schema_config.sql)
  # ---------------------------------------------------------------------
  # Domains with auto-generated schema names from folder structure
  auto_schema_domains: ['olids']

  # ---------------------------------------------------------------------
  # Flu Campaign (defaults in macros/config/flu_campaign_selection.sql)
  # ---------------------------------------------------------------------
  # Uncomment to override campaign selection:
  # flu_current_campaign: "Flu 2025-26"
  # flu_previous_campaign: "Flu 2024-25"
  # flu_audit_end_date: "CURRENT_DATE"

  # ---------------------------------------------------------------------
  # COVID Campaign (defaults in macros/config/covid_campaign_selection.sql)
  # ---------------------------------------------------------------------
  # Uncomment to override campaign selection:
  # covid_current_autumn: "COVID Autumn 2025"
  # covid_current_spring: "COVID Spring 2025"
  # covid_previous_autumn: "COVID Autumn 2024"
  # covid_previous_spring: "COVID Spring 2025"
  # covid_audit_end_date: "2025-06-30"
  
  # ---------------------------------------------------------------------
  # Elementary (defaults in macros/config/elementary_config.sql)
  # ---------------------------------------------------------------------
  # These use Jinja to evaluate at runtime based on target
  disable_dbt_artifacts_autoupload: "{{ should_disable_dbt_artifacts_autoupload() }}"
  disable_run_results: "{{ should_disable_run_results() }}"
  disable_tests_results: "{{ should_disable_tests_results() }}"
  disable_dbt_invocation_autoupload: "{{ should_disable_dbt_invocation_autoupload() }}"

# Configure test failure storage (only for failures)
tests:
  +store_failures: false
  +schema: "test_audit"

models:
  ncl_analytics:
    +materialized: table
    +persist_docs:
      columns: true
    +post-hook: ["{{ grant_ownership_with_copy() }}"]
    +enabled: true

    # Raw layer - source data with minimal transformation
    raw:
      +materialized: view
      +database: "MODELLING"
      +schema: "DBT_RAW"
      +tags: ["raw", "daily"]
      +post-hook: ["{{ add_model_comment() }}"]

    # Staging layer - cleaned and standardised source data
    staging:
      +materialized: view
      +database: "MODELLING"
      +schema: "DBT_STAGING"
      +tags: ["staging", "daily"]
      +post-hook: ["{{ add_model_comment() }}"]
      olids:
        +meta:
          custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"

    # Modelling layer - business logic and transformations
    modelling:
      +enabled: true
      +materialized: table
      +database: "MODELLING"
      +tags: ["modelling"]
      +post-hook:
        - "{{ add_model_comment() }}"
        - "{{ log_row_count() }}"
      commissioning:
        +schema: "COMMISSIONING_MODELLING"
      olids:
        +meta:
          custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"

    # Reporting layer - aggregated and analytical models
    reporting:
      +enabled: true
      +materialized: table
      +database: "REPORTING"
      +tags: ["reporting"]
      +post-hook:
        - "{{ add_model_comment() }}"
        - "{{ log_row_count() }}"
      commissioning:
        +schema: "COMMISSIONING_REPORTING"
      olids:
        +meta:
          custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"
        # Schema names automatically derived from subdomain folder names via generate_schema_name macro
        definitions:
          +database: "{{ target.database.replace('MODELLING', 'REPORTING') }}"

    # Published layer - production-ready datasets for end users
    published:
      +enabled: true
      +materialized: table
      +tags: ["published_reporting"]
      +post-hook:
        - "{{ add_model_comment() }}"
        - "{{ log_row_count() }}"
      direct_care:
        +database: "PUBLISHED_REPORTING__DIRECT_CARE"
        olids:
          +meta:
            custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"
          # Schema names automatically derived from subdomain folder names via generate_schema_name macro
        C_LTCS:
          +meta:
            custom_message: "Requires access via application role - clinical programme team only."
          +schema: "C_LTCS"
      secondary_use:
        +database: "PUBLISHED_REPORTING__SECONDARY_USE"
        olids:
          +meta:
            custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"
          # Schema names automatically derived from subdomain folder names via generate_schema_name macro
          +post-hook:
            - "{{ add_model_comment() }}"
            - "{{ apply_snowflake_tag_if_tagged('secondary_use_opt_out', 'DATA_CATEGORY', 'PRIMARY_CARE_SECONDARY_USE') }}"
            - "{{ log_row_count() }}"

  # Elementary observability configuration
  elementary:
    +enabled: "{{ target.name in ['prod', 'snowflake-prod'] }}"  # Only run Elementary in prod
    +database: "DATA_LAKE__NCL"
    +schema: "DBT_OBSERVABILITY"

seeds:
  ncl_analytics:
    +database: "DATA_LAKE__NCL"
    +schema: "DBT_SEEDS"
    +quote_columns: false

    bnf_polypharmacy_exclusions:
      +column_types:
        bnf_chapter_code: varchar(10)
        chapter_name: varchar(200)
        is_excluded: boolean

    ethnicity_snomed_ONS_NHS:
      +column_types:
        SNOMED_CODE: varchar
        SNOMED_TERM: varchar
        CATEGORY: varchar
        SUBCATEGORY: varchar
        GRANULAR: varchar
        ONS_BRIDGE_CODE: varchar
        ONS_BRIDGE_LABEL: varchar
        BK_ETHNICITY_CODE: varchar
        ETHNICITY_DESC: varchar

    emis_list_size:
      +column_types:
        BOROUGH: varchar(50)
        CODE: varchar(10)
        GP_PRACTICE: varchar(200)
        LIST_SIZE: integer
        EXTRACT_DATE: varchar(10)
    
    asthma_testing_codelist:
      +column_types:
        CODE: varchar(50)
        CODE_DESCRIPTION: varchar(200)
        VOCABULARY: varchar(200)
        CODELIST_ID: varchar(200)
        CODELIST_NAME: varchar(200)
        CODELIST_VERSION: varchar(200)
        DEFINITION_NAME: varchar(200)
        DEFINITION_VERSION: varchar(200)
        DEFINITION_SOURCE: varchar(200)
        VERSION_DATETIME:	varchar(200)
        UPLOADED_DATETIME: varchar(200)



snapshots:
  ncl_analytics:
    +database: "MODELLING"
    +schema: "DBT_SNAPSHOTS"