name: 'ncl_analytics'
version: '1.20.1'
config-version: 2

profile: 'ncl_analytics'

flags:
  partial_parse: true

# Display connection info when dbt runs start
on-run-start:
  - "{{ log('ðŸ”— DBT CONNECTION: Role=' ~ target.role ~ ', Warehouse=' ~ target.warehouse ~ ', Database=' ~ target.database ~ ', Schema=' ~ target.schema ~ ', Target=' ~ target.name, info=True) }}"
  - "{% if flags.WHICH in ['run', 'build'] %}{{ ensure_governance_tags() }}{% endif %}"
  - "{% if flags.WHICH in ['run', 'build'] %}{{ create_row_count_log_table() }}{% endif %}"

target-path: "target"
clean-targets:
  - "target"
  - "dbt_modules"

model-paths: ["models"]

# Configuration moved to macros/config/ - see macros/config/README.md
vars:
  dbt_audit_schema: "test_audit"
  auto_schema_domains: ['olids']
  qof_reference_date: "2025-11-04"  # EMIS QOF extract date, override via --vars
  
  # Elementary observability
  disable_dbt_artifacts_autoupload: "{{ target.name not in ['prod', 'snowflake-prod'] }}"
  disable_run_results: "{{ target.name not in ['prod', 'snowflake-prod'] }}"
  disable_tests_results: "{{ target.name not in ['prod', 'snowflake-prod'] }}"
  disable_dbt_invocation_autoupload: "{{ target.name not in ['prod', 'snowflake-prod'] }}"

# Configure test failure storage (only for failures)
tests:
  +store_failures: false
  +schema: "test_audit"

models:
  ncl_analytics:
    +materialized: table
    +persist_docs:
      columns: true
    +post-hook: ["{{ grant_ownership_with_copy() }}"]
    +enabled: true

    # Raw layer - source data with minimal transformation
    raw:
      +materialized: view
      +database: "MODELLING"
      +schema: "DBT_RAW"
      +tags: ["raw", "daily"]
      +post-hook: ["{{ add_model_comment() }}"]

    # Staging layer - cleaned and standardised source data
    staging:
      +materialized: view
      +database: "MODELLING"
      +schema: "DBT_STAGING"
      +tags: ["staging", "daily"]
      +post-hook: ["{{ add_model_comment() }}"]
      olids:
        +meta:
          custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"

    # Modelling layer - business logic and transformations
    modelling:
      +enabled: true
      +materialized: table
      +database: "MODELLING"
      +tags: ["modelling"]
      +post-hook:
        - "{{ add_model_comment() }}"
        - "{{ log_row_count() }}"
      commissioning:
        +schema: "COMMISSIONING_MODELLING"
      olids:
        +meta:
          custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"

    # Reporting layer - aggregated and analytical models
    reporting:
      +enabled: true
      +materialized: table
      +database: "REPORTING"
      +tags: ["reporting"]
      +post-hook:
        - "{{ add_model_comment() }}"
        - "{{ log_row_count() }}"
      commissioning:
        +schema: "COMMISSIONING_REPORTING"
      olids:
        +meta:
          custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"
        # Schema names automatically derived from subdomain folder names via generate_schema_name macro
        definitions:
          +database: "{{ target.database.replace('MODELLING', 'REPORTING') }}"

    # Published layer - production-ready datasets for end users
    published:
      +enabled: true
      +materialized: table
      +tags: ["published_reporting"]
      +post-hook:
        - "{{ add_model_comment() }}"
        - "{{ log_row_count() }}"
      direct_care:
        +database: "PUBLISHED_REPORTING__DIRECT_CARE"
        olids:
          +meta:
            custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"
          # Schema names automatically derived from subdomain folder names via generate_schema_name macro
        C_LTCS:
          +meta:
            custom_message: "Requires access via application role - clinical programme team only."
          +schema: "C_LTCS"
      secondary_use:
        +database: "PUBLISHED_REPORTING__SECONDARY_USE"
        olids:
          +meta:
            custom_message: "Includes OLIDS data - don't publish/share outputs without DAC approval"
          # Schema names automatically derived from subdomain folder names via generate_schema_name macro
          +post-hook:
            - "{{ add_model_comment() }}"
            - "{{ apply_snowflake_tag_if_tagged('secondary_use_opt_out', 'DATA_CATEGORY', 'PRIMARY_CARE_SECONDARY_USE') }}"
            - "{{ log_row_count() }}"

  # Elementary observability configuration
  elementary:
    +enabled: "{{ target.name in ['prod', 'snowflake-prod'] }}"  # Only run Elementary in prod
    +database: "DATA_LAKE__NCL"
    +schema: "DBT_OBSERVABILITY"

seeds:
  ncl_analytics:
    +database: "DATA_LAKE__NCL"
    +schema: "DBT_SEEDS"
    +quote_columns: false

    bnf_polypharmacy_exclusions:
      +column_types:
        bnf_chapter_code: varchar(10)
        chapter_name: varchar(200)
        is_excluded: boolean

    ethnicity_snomed_ONS_NHS:
      +column_types:
        SNOMED_CODE: varchar
        SNOMED_TERM: varchar
        CATEGORY: varchar
        SUBCATEGORY: varchar
        GRANULAR: varchar
        ONS_BRIDGE_CODE: varchar
        ONS_BRIDGE_LABEL: varchar
        BK_ETHNICITY_CODE: varchar
        ETHNICITY_DESC: varchar

    emis_list_size:
      +column_types:
        BOROUGH: varchar(50)
        CODE: varchar(10)
        GP_PRACTICE: varchar(200)
        LIST_SIZE: integer
        EXTRACT_DATE: varchar(10)
    
    asthma_testing_codelist:
      +column_types:
        CODE: varchar(50)
        CODE_DESCRIPTION: varchar(200)
        VOCABULARY: varchar(200)
        CODELIST_ID: varchar(200)
        CODELIST_NAME: varchar(200)
        CODELIST_VERSION: varchar(200)
        DEFINITION_NAME: varchar(200)
        DEFINITION_VERSION: varchar(200)
        DEFINITION_SOURCE: varchar(200)
        VERSION_DATETIME:	varchar(200)
        UPLOADED_DATETIME: varchar(200)

    observation_unit_rules:
      +column_types:
        DEFINITION_ID: varchar(50)
        DEFINITION_NAME: varchar(50)
        CONFIG_ID: varchar(50)
        CONFIG_VERSION: varchar(20)
        CONVERT_FROM_UNIT: varchar(50)
        CONVERT_TO_UNIT: varchar(20)
        MULTIPLY_BY: float
        PRE_OFFSET: float
        POST_OFFSET: float

    observation_standard_units:
      +column_types:
        DEFINITION_ID: varchar(50)
        DEFINITION_NAME: varchar(50)
        CONFIG_ID: varchar(50)
        CONFIG_VERSION: varchar(20)
        UNIT: varchar(20)
        PRIMARY_UNIT: boolean

    observation_value_bounds:
      +column_types:
        DEFINITION_ID: varchar(50)
        DEFINITION_NAME: varchar(50)
        CONFIG_ID: varchar(50)
        CONFIG_VERSION: varchar(20)
        LOWER_LIMIT: float
        UPPER_LIMIT: float
        CANONICAL_EXPONENT: integer
        EXPECTED_LOWER: float

snapshots:
  ncl_analytics:
    +database: "MODELLING"
    +target_schema: "DBT_SNAPSHOTS"
