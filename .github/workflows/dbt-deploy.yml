name: dbt Deploy to Production

on:
  workflow_dispatch:  # Manual only until Snowflake permissions configured
  # TODO: Enable after permissions granted:
  # push:
  #   branches: [main]
  #   paths:
  #     - 'models/**'
  #     - 'macros/**'

jobs:
  deploy-models:
    name: Deploy Changed Models + Downstream
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install snowflake-connector-python

      - name: Get changed models
        id: changes
        run: |
          # For push events, compare with previous commit
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- 'models/**/*.sql' | tr '\n' ' ')
          else
            # For manual trigger, default to empty (will trigger full build)
            CHANGED=""
          fi
          COUNT=$(echo "$CHANGED" | wc -w)
          echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT
          echo "file_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT changed model files"

      - name: Setup Snowflake credentials
        run: |
          mkdir -p ~/.snowflake
          echo "${{ secrets.SNOWFLAKE__PRIVATE_KEY }}" > ~/.snowflake/rsa_key.p8
          chmod 600 ~/.snowflake/rsa_key.p8

      - name: Deploy to Snowflake PROD
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE__USERNAME }}
          SNOWFLAKE_PRIVATE_KEY_PATH: ~/.snowflake/rsa_key.p8
          SNOWFLAKE_PRIVATE_KEY_PASSPHRASE: ${{ secrets.SNOWFLAKE__PASSPHRASE }}
          CHANGED_FILES: ${{ steps.changes.outputs.changed_files }}
          FILE_COUNT: ${{ steps.changes.outputs.file_count }}
        run: |
          python << 'EOF'
          import os
          import snowflake.connector
          from cryptography.hazmat.primitives import serialization
          from cryptography.hazmat.backends import default_backend

          with open(os.path.expanduser(os.environ['SNOWFLAKE_PRIVATE_KEY_PATH']), 'rb') as key_file:
              p_key = serialization.load_pem_private_key(
                  key_file.read(),
                  password=os.environ.get('SNOWFLAKE_PRIVATE_KEY_PASSPHRASE', '').encode(),
                  backend=default_backend()
              )

          pkb = p_key.private_bytes(
              encoding=serialization.Encoding.DER,
              format=serialization.PrivateFormat.PKCS8,
              encryption_algorithm=serialization.NoEncryption()
          )

          conn = snowflake.connector.connect(
              account=os.environ['SNOWFLAKE_ACCOUNT'],
              user=os.environ['SNOWFLAKE_USER'],
              private_key=pkb,
              role='DBT_DEPLOYMENT_TESTER',
              database='ACCOUNT_ADMIN',
              schema='DBT_MANAGEMENT',
              warehouse='WH_NCL_ENGINEERING_XS'
          )

          cur = conn.cursor()
          cur.execute("USE WAREHOUSE WH_NCL_ENGINEERING_XS")

          print("Fetching git repository...")
          cur.execute("ALTER GIT REPOSITORY REPO__GITHUB__DBT_NCL_ANALYTICS FETCH")

          print("Updating project to main branch...")
          cur.execute("""
              ALTER DBT PROJECT DBT_NCL_ANALYTICS__MAIN
              ADD VERSION FROM '@REPO__GITHUB__DBT_NCL_ANALYTICS/branches/main'
          """)

          # Build selection from changed files
          file_count = int(os.environ.get('FILE_COUNT', 0))
          changed_files = os.environ.get('CHANGED_FILES', '').strip()

          if file_count == 0 or file_count > 50:
              print(f"Running full build ({file_count} files changed or manual trigger)")
              args = "build --target snowflake-prod"
          else:
              # Build changed models + downstream
              models = []
              for f in changed_files.split():
                  model_name = f.split('/')[-1].replace('.sql', '')
                  models.append(model_name + '+')  # + for downstream
              select = ' '.join(models)
              print(f"Deploying {file_count} changed models + downstream: {select}")
              args = f"build --target snowflake-prod --select {select}"

          print(f"Executing: dbt {args}")
          cur.execute(f"""
              EXECUTE DBT PROJECT DBT_NCL_ANALYTICS__MAIN
              ARGS = '{args}'
          """)

          results = cur.fetchall()
          for row in results:
              print(row)

          cur.close()
          conn.close()
          print("Deployment complete!")
          EOF
