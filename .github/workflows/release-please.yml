name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: simple

      # Debug outputs
      - name: Debug outputs
        run: |
          echo "release_created: ${{ steps.release.outputs.release_created }}"
          echo "prs_created: ${{ steps.release.outputs.prs_created }}"
          PR_OUTPUT='${{ steps.release.outputs.pr }}'
          echo "pr output: $PR_OUTPUT"
          echo "tag_name: ${{ steps.release.outputs.tag_name }}"

      # Checkout code for gh CLI
      - name: Checkout code
        if: ${{ steps.release.outputs.pr }}
        uses: actions/checkout@v4

      # Auto-merge Release PR
      - name: Auto-merge Release PR
        if: ${{ steps.release.outputs.pr }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Parse PR number from JSON output
          PR_JSON='${{ steps.release.outputs.pr }}'
          echo "PR JSON: $PR_JSON"
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
          echo "Enabling auto-merge for Release PR #$PR_NUMBER"
          # Attempt to enable auto-merge, but don't fail the workflow if it can't be enabled
          # This can happen if the PR is already mergeable (clean status) or due to GitHub API timing
          gh pr merge $PR_NUMBER --auto --squash --delete-branch || echo "Warning: Could not enable auto-merge for PR #$PR_NUMBER. PR may already be mergeable or auto-merge may need to be enabled manually."

      # Checkout code if a release was created
      - name: Checkout code
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Analyse dbt model changes
      - name: Analyse dbt model changes
        if: ${{ steps.release.outputs.release_created }}
        id: analyse
        run: |
          chmod +x .github/scripts/analyse-dbt-changes.sh

          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)

          # Run analysis
          .github/scripts/analyse-dbt-changes.sh "$PREV_TAG" "${{ steps.release.outputs.tag_name }}" > /tmp/dbt-analysis.md

          echo "Analysis complete"
          cat /tmp/dbt-analysis.md

      # Update release notes with dbt analysis
      - name: Update release notes
        if: ${{ steps.release.outputs.release_created }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current release notes and save to file
          gh release view "${{ steps.release.outputs.tag_name }}" --json body -q .body > /tmp/current-notes.md

          # Combine notes using cat
          cat /tmp/current-notes.md > /tmp/combined-notes.md
          echo "" >> /tmp/combined-notes.md
          echo "---" >> /tmp/combined-notes.md
          echo "" >> /tmp/combined-notes.md
          echo "## dbt Models Changed" >> /tmp/combined-notes.md
          echo "" >> /tmp/combined-notes.md
          cat /tmp/dbt-analysis.md >> /tmp/combined-notes.md

          # Update release with combined notes
          gh release edit "${{ steps.release.outputs.tag_name }}" --notes-file /tmp/combined-notes.md
