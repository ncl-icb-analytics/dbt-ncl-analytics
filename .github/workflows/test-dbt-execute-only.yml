name: Test dbt Execute Only

on:
  workflow_dispatch:

jobs:
  test-execute:
    name: Test dbt Execute Only
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install snowflake-connector-python

      - name: Setup Snowflake credentials
        run: |
          mkdir -p ~/.snowflake
          echo "${{ secrets.SNOWFLAKE__PRIVATE_KEY }}" > ~/.snowflake/rsa_key.p8
          chmod 600 ~/.snowflake/rsa_key.p8

      - name: Execute dbt project (no alter)
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE__USERNAME }}
          SNOWFLAKE_PRIVATE_KEY_PATH: ~/.snowflake/rsa_key.p8
          SNOWFLAKE_PRIVATE_KEY_PASSPHRASE: ${{ secrets.SNOWFLAKE__PASSPHRASE }}
        run: |
          python << 'EOF'
          import os
          import snowflake.connector
          from cryptography.hazmat.primitives import serialization
          from cryptography.hazmat.backends import default_backend

          with open(os.path.expanduser(os.environ['SNOWFLAKE_PRIVATE_KEY_PATH']), 'rb') as key_file:
              p_key = serialization.load_pem_private_key(
                  key_file.read(),
                  password=os.environ.get('SNOWFLAKE_PRIVATE_KEY_PASSPHRASE', '').encode(),
                  backend=default_backend()
              )

          pkb = p_key.private_bytes(
              encoding=serialization.Encoding.DER,
              format=serialization.PrivateFormat.PKCS8,
              encryption_algorithm=serialization.NoEncryption()
          )

          conn = snowflake.connector.connect(
              account=os.environ['SNOWFLAKE_ACCOUNT'],
              user=os.environ['SNOWFLAKE_USER'],
              private_key=pkb,
              role='DBT_DEPLOYMENT_TESTER',
              database='ACCOUNT_ADMIN',
              schema='DBT_MANAGEMENT',
              warehouse='WH_NCL_ENGINEERING_XS'
          )

          cur = conn.cursor()

          # Activate warehouse
          print("Setting warehouse...")
          cur.execute("USE WAREHOUSE WH_NCL_ENGINEERING_XS")

          # Skip ALTER - just execute directly
          print("Executing dbt project (execute only, no alter)...")
          cur.execute("""
              EXECUTE DBT PROJECT DBT_NCL_ANALYTICS__MAIN
              ARGS = 'build -s tag:raw --target snowflake-dev'
          """)

          results = cur.fetchall()
          for row in results:
              print(row)

          cur.close()
          conn.close()
          print("Done!")
          EOF
