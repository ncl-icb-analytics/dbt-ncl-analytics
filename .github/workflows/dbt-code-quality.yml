name: dbt Code Quality

on:
  pull_request:
    branches: [main]

jobs:
  hardcoded-references:
    name: No Hardcoded Table References
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed
        run: |
          echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(sql)$' | grep -E '^(models|macros|analyses)/' | tr '\n' ' ')" >> $GITHUB_OUTPUT
      - name: Run check
        if: steps.changed.outputs.files != ''
        run: |
          bash scripts/ci/check_hardcoded_refs.sh ${{ steps.changed.outputs.files }} | tee result.txt
          cat result.txt >> $GITHUB_STEP_SUMMARY
          grep -q "^FAILED" result.txt && exit 1 || exit 0

  staging-references:
    name: Raw/Source References Only in Staging
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed
        run: |
          echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.sql$' | grep -E '^models/' | tr '\n' ' ')" >> $GITHUB_OUTPUT
      - name: Run check
        if: steps.changed.outputs.files != ''
        run: |
          bash scripts/ci/check_staging_refs.sh ${{ steps.changed.outputs.files }} | tee result.txt
          cat result.txt >> $GITHUB_STEP_SUMMARY
          grep -q "^FAILED" result.txt && exit 1 || exit 0

  model-descriptions:
    name: Model Descriptions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Python deps
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml
      - name: Get changed files
        id: changed
        run: |
          echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.sql$' | grep -E '^models/' | tr '\n' ' ')" >> $GITHUB_OUTPUT
      - name: Run check
        if: steps.changed.outputs.files != ''
        run: |
          python3 scripts/ci/check_model_descriptions.py ${{ steps.changed.outputs.files }} | tee result.txt
          cat result.txt >> $GITHUB_STEP_SUMMARY
          grep -q "^FAILED" result.txt && exit 1 || exit 0

  model-tests:
    name: Model Test Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      - name: Get changed files
        id: changed
        run: |
          echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.sql$' | grep -E '^models/' | tr '\n' ' ')" >> $GITHUB_OUTPUT
      - name: Run check
        if: steps.changed.outputs.files != ''
        run: |
          bash scripts/ci/check_model_tests.sh ${{ steps.changed.outputs.files }} | tee result.txt
          cat result.txt >> $GITHUB_STEP_SUMMARY
          grep -q "^FAILED" result.txt && exit 1 || exit 0
