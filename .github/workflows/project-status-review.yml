name: Project Status - Code Review

on:
  pull_request_target:
    types: [review_requested, ready_for_review]

jobs:
  update-project-status:
    name: Set Project Status to Code Review
    runs-on: ubuntu-latest
    # Skip draft PRs. For ready_for_review, only proceed if reviewers exist.
    if: |
      !github.event.pull_request.draft &&
      (
        github.event.action == 'review_requested' ||
        (
          github.event.action == 'ready_for_review' &&
          (
            github.event.pull_request.requested_reviewers[0] != null ||
            github.event.pull_request.requested_teams[0] != null
          )
        )
      )
    steps:
      - name: Update project status to Code Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const projectNumber = 3;
            const org = 'ncl-icb-analytics';
            const targetStatus = 'Code Review';
            const prNodeId = context.payload.pull_request.node_id;

            // Get project ID
            const { organization } = await github.graphql(`
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                  }
                }
              }
            `, { org, number: projectNumber });

            const projectId = organization.projectV2.id;

            // Get Status field and "Code Review" option
            const { node: project } = await github.graphql(`
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options { id name }
                      }
                    }
                  }
                }
              }
            `, { projectId });

            const statusField = project.field;
            if (!statusField?.id) {
              core.setFailed('Status field not found in project');
              return;
            }

            const option = statusField.options.find(o => o.name === targetStatus);
            if (!option) {
              const available = statusField.options.map(o => o.name).join(', ');
              core.setFailed(`"${targetStatus}" option not found. Available: ${available}`);
              return;
            }

            // Add PR to project (idempotent â€” returns existing item if already present)
            const { addProjectV2ItemById } = await github.graphql(`
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item { id }
                }
              }
            `, { projectId, contentId: prNodeId });

            const itemId = addProjectV2ItemById.item.id;

            // Set status to "Code Review"
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }
            `, { projectId, itemId, fieldId: statusField.id, optionId: option.id });

            core.info(`PR #${context.payload.pull_request.number} status set to "${targetStatus}"`);
